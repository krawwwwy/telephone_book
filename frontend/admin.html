<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="Росатом" class="logo">
            <span class="company-name">РОСАТОМ</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">Телефонный справочник</h1>
        </div>
        <div class="header-right">
            <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
        </div>
    </header>

    <div class="admin-container">
        <button class="btn-secondary" onclick="window.history.back()">Вернуться</button>
        <h1>Панель Администратора</h1>
        <div class="admin-buttons">
            <button class="add-btn" onclick="openModal('addUserModal')">Создать пользователя системы</button>
            <button class="add-btn" onclick="openModal('addDepartmentModal')">Добавить отдел</button>
        </div>

        <div class="edit-departments-section">
            <h2>Редактирование отделов</h2>
            <div class="division-tabs">
                <button class="division-tab active" data-division="giredmet">Гиредмет</button>
                <button class="division-tab" data-division="grafit">Графит</button>
            </div>

            <div class="departments-editor">
                <div class="departments-list" id="departmentsList"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Если обнаружили неточности, напишите на почту it_rosatom@mail.ru
    </footer>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Создание пользователя системы</h2>
            <p class="modal-subtitle">Создание учетной записи для входа в систему</p>

            <input type="text" placeholder="Email (логин)*" class="auth-input">
            <input type="password" placeholder="Пароль*" class="auth-input" autocomplete="new-password">

            <div class="role-selection">
                <p class="role-title">Выберите роль пользователя:</p>
                <div class="role-options">
                    <label class="role-option">
                        <input type="radio" name="userRole" value="user" checked>
                        <span class="role-checkmark"></span>
                        <span class="role-label">Пользователь (может просматривать данные)</span>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="userRole" value="admin">
                        <span class="role-checkmark"></span>
                        <span class="role-label">Администратор (полный доступ)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('addUserModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="submitUser()">Создать пользователя</button>
            </div>
        </div>
    </div>

    <div id="addDepartmentModal" class="modal">
        <div class="modal-content">
            <h2>Добавление отдела</h2>
            <p class="modal-subtitle">Заполните поля</p>
            <div class="form-group">
                <input type="text" placeholder="Название отдела*" id="departmentName" class="form-input" required>
            </div>

            <div class="form-group">
                <input type="text" placeholder="Институт*" id="instituteName" class="form-input" required>
            </div>

            <div class="subdepartments-section">
                <div class="section-header">
                    <h3>Подотделы (необязательно)</h3>
                    <button type="button" class="add-subdepartment-btn" onclick="addSubdepartmentField()">
                        <span>+</span> Добавить подотдел
                    </button>
                </div>

                <div class="subdepartments-list" id="subdepartmentsList">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('addDepartmentModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="submitDepartment()">Создать</button>
            </div>
        </div>
    </div>

    <div id="editDepartmentModal" class="modal">
        <div class="modal-content">
            <h2>Редактирование отдела</h2>

            <div class="form-group">
                <label>Название отдела:</label>
                <input type="text" id="editDeptName" class="form-input">
            </div>

            <div class="subdepartments-section">
                <div class="section-header">
                    <h3>Подотделы</h3>
                    <button type="button" class="add-subdepartment-btn" onclick="addSubdepartmentField(true)">
                        <span>+</span> Добавить подотдел
                    </button>
                </div>

                <div class="subdepartments-list" id="editSubdepartmentsList"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('editDepartmentModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="saveDepartmentChanges()">Сохранить</button>
            </div>
        </div>
    </div>

    <div id="deleteDepartmentModal" class="modal">
        <div class="modal-content">
            <h2>Удаление отдела</h2>
            <p id="deleteDeptConfirmText">Вы уверены, что хотите удалить отдел "<span id="deptNameToDelete"></span>"?
            </p>
            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('deleteDepartmentModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="confirmDepartmentDeletion()">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        // Переменные для редактирования и удаления отделов
        let currentEditingDepartment = null;
        let currentEditingInstitute = null;
        let currentDeletingDepartment = null;
        let currentDeletingInstitute = null;

        // Функции для работы с модальными окнами
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Очищаем формы при закрытии
            if (modalId === 'addDepartmentModal') {
                clearDepartmentForm();
            } else if (modalId === 'editDepartmentModal') {
                // Очищаем переменные редактирования
                currentEditingDepartment = null;
                currentEditingInstitute = null;
                document.getElementById('editDeptName').value = '';
                document.getElementById('editSubdepartmentsList').innerHTML = '';
            } else if (modalId === 'deleteDepartmentModal') {
                // Очищаем переменные удаления
                currentDeletingDepartment = null;
                currentDeletingInstitute = null;
            } else if (modalId === 'addUserModal') {
                // Очищаем форму создания пользователя
                const modal = document.getElementById('addUserModal');
                modal.querySelector('input[type="text"]').value = '';
                modal.querySelector('input[type="password"]').value = '';
                modal.querySelector('input[name="userRole"][value="user"]').checked = true;
            }
        }

        // Очистка формы добавления отдела
        function clearDepartmentForm() {
            document.getElementById('departmentName').value = '';
            document.getElementById('instituteName').value = '';
            
            // Очищаем список подотделов
            document.getElementById('subdepartmentsList').innerHTML = '';
        }

        // Добавление поля для подотдела
        function addSubdepartmentField(isEdit = false) {
            const container = isEdit ? 
                document.getElementById('editSubdepartmentsList') : 
                document.getElementById('subdepartmentsList');
            
            const subdepartmentDiv = document.createElement('div');
            subdepartmentDiv.className = 'subdepartment-field';
            subdepartmentDiv.innerHTML = `
                <input type="text" placeholder="Название подотдела" class="form-input subdepartment-input">
                <button type="button" class="remove-subdepartment-btn" onclick="removeSubdepartmentField(this)">
                    <span>−</span> Удалить
                </button>
            `;
            
            container.appendChild(subdepartmentDiv);
        }

        // Удаление поля подотдела
        function removeSubdepartmentField(button) {
            button.parentElement.remove();
        }

        // Отправка данных для создания отдела
        async function submitDepartment() {
            const modal = document.getElementById('addDepartmentModal');
            const inputs = modal.querySelectorAll('.form-input');
            
            const departmentName = inputs[0].value.trim();
            const institute = inputs[1].value.trim();
            
            // Валидация
            if (!departmentName) {
                alert('Пожалуйста, введите название отдела');
                return;
            }
            
            if (!institute) {
                alert('Пожалуйста, введите институт');
                return;
            }

            // Собираем подотделы
            const subdepartmentInputs = modal.querySelectorAll('.subdepartment-input');
            const sections = Array.from(subdepartmentInputs)
                .map(input => input.value.trim())
                .filter(value => value.length > 0);

            const requestData = {
                name: departmentName,
                institute: institute,
                sections: sections
            };

            console.log('Отправляем данные для создания отдела:', requestData);

            // Проверяем токен авторизации
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Для создания отдела необходимо авторизоваться');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/departments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                console.log('Ответ сервера:', result);

                if (result.status === 'Ok') {
                    alert('Отдел успешно создан');
                    closeModal('addDepartmentModal');
                    // Перезагружаем список отделов для текущего института
                    const activeTab = document.querySelector('.division-tab.active');
                    if (activeTab) {
                        const currentInstitute = activeTab.getAttribute('data-division');
                        loadDepartments(currentInstitute);
                    }
                } else {
                    alert('Ошибка при создании отдела: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при создании отдела:', error);
                alert('Ошибка при создании отдела: ' + error.message);
            }
        }

        // Создание пользователя системы
        async function submitUser() {
            const modal = document.getElementById('addUserModal');
            const loginInput = modal.querySelector('input[type="text"]');
            const passwordInput = modal.querySelector('input[type="password"]');
            const selectedRole = modal.querySelector('input[name="userRole"]:checked');

            // Валидация
            if (!loginInput.value.trim()) {
                alert('Пожалуйста, введите логин пользователя');
                return;
            }

            if (!passwordInput.value.trim()) {
                alert('Пожалуйста, введите пароль');
                return;
            }

            if (passwordInput.value.length < 6) {
                alert('Пароль должен содержать минимум 6 символов');
                return;
            }

            if (!selectedRole) {
                alert('Пожалуйста, выберите роль пользователя');
                return;
            }

            // Проверка email формата
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(loginInput.value.trim())) {
                alert('Пожалуйста, введите корректный email адрес');
                return;
            }

            const requestData = {
                email: loginInput.value.trim(),
                password: passwordInput.value,
                role: selectedRole.value
            };

            console.log('Создаем пользователя системы:', { ...requestData, password: '***' });

            // Проверяем токен авторизации
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Для создания пользователя необходимо авторизоваться');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                console.log('Ответ сервера при создании пользователя:', result);

                if (result.status === 'Ok') {
                    alert(`Пользователь системы успешно создан!\nEmail: ${requestData.email}\nРоль: ${requestData.role === 'admin' ? 'Администратор' : 'Пользователь'}\nUser ID: ${result.user_id}`);
                    closeModal('addUserModal');
                    
                    // Очищаем форму
                    loginInput.value = '';
                    passwordInput.value = '';
                    modal.querySelector('input[name="userRole"][value="user"]').checked = true;
                } else {
                    alert('Ошибка при создании пользователя: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при создании пользователя:', error);
                alert('Ошибка при создании пользователя: ' + error.message);
            }
        }

        // Загрузка отделов для админ-панели
        async function loadDepartments(institute = 'giredmet') {
            try {
                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                console.log(`Отделы для ${institute}:`, data);
                
                const departmentsList = document.getElementById('departmentsList');
                departmentsList.innerHTML = '';
                
                if (data.status === 'Ok' && data.departments) {
                    data.departments.forEach(async dept => {
                        const deptDiv = document.createElement('div');
                        deptDiv.className = 'department-item admin-dept-item';
                        
                        // Загружаем информацию о подотделах
                        let sectionsInfo = '';
                        try {
                            const sectionsResponse = await fetch(`${API_BASE}/departments/${encodeURIComponent(dept.name)}?institute=${encodeURIComponent(institute)}`);
                            const sectionsData = await sectionsResponse.json();
                            if (sectionsData.status === 'Ok' && sectionsData.sections) {
                                const sectionsCount = sectionsData.sections.length;
                                sectionsInfo = sectionsCount > 0 ? ` (${sectionsCount} подотдел${sectionsCount === 1 ? '' : sectionsCount < 5 ? 'а' : 'ов'})` : '';
                            }
                        } catch (error) {
                            console.log('Не удалось загрузить информацию о подотделах для', dept.name);
                        }
                        
                        deptDiv.innerHTML = `
                            <div class="dept-info">
                                <div class="dept-name">${dept.name}${sectionsInfo}</div>
                            </div>
                            <div class="dept-actions">
                                <button class="edit-btn" onclick="editDepartment('${dept.name}', '${institute}')">Редактировать</button>
                                <button class="delete-btn" onclick="deleteDepartment('${dept.name}', '${institute}')">Удалить</button>
                            </div>
                        `;
                        departmentsList.appendChild(deptDiv);
                    });
                } else {
                    departmentsList.innerHTML = '<p>Отделы не найдены</p>';
                }
            } catch (error) {
                console.error('Ошибка загрузки отделов:', error);
                document.getElementById('departmentsList').innerHTML = '<p>Ошибка загрузки отделов</p>';
            }
        }

        // Переключение между институтами
        function switchInstitute(institute) {
            // Обновляем активную вкладку
            document.querySelectorAll('.division-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-division="${institute}"]`).classList.add('active');
            
            // Загружаем отделы для выбранного института
            loadDepartments(institute);
        }

        // Обработчики для вкладок институтов
        document.addEventListener('DOMContentLoaded', function() {
            // Сначала проверяем доступ
            checkAdminAccess();
            
            document.querySelectorAll('.division-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const institute = this.getAttribute('data-division');
                    switchInstitute(institute);
                });
            });
        });

        // Закрытие модальных окон по клику вне их
        window.onclick = function (event) {
            const modals = ['addUserModal', 'addDepartmentModal', 'editDepartmentModal', 'deleteDepartmentModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    closeModal(modalId);
                }
            });
        };
        
        // Загрузка всех пользователей
        async function loadAllUsers() {
            try {
                const institutes = ['giredmet', 'grafit'];
                const tbody = document.querySelector('.admin-table tbody');
                
                // Проверяем, существует ли таблица пользователей
                if (!tbody) {
                    console.log('Таблица пользователей не найдена в админ-панели - пропускаем загрузку');
                    return;
                }
                
                tbody.innerHTML = '';
                
                for (const institute of institutes) {
                    const response = await fetch(`${API_BASE}/workers/all?institute=${institute}&department=`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'Ok' && data.users) {
                        data.users.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${user.department || ''}</td>
                                <td>${user.phone || ''}</td>
                                <td>${user.email || ''}</td>
                                <td>${user.cabinet || ''}</td>
                                <td>
                                    <button class="edit-btn" onclick="editUser('${user.email}', '${institute}')">Редактировать</button>
                                    <button class="delete-btn" onclick="deleteUser('${user.email}', '${institute}')">Удалить</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }

        // Удаление пользователя
        async function deleteUser(email, institute) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/workers?institute=${institute}&email=${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Пользователь удален');
                    loadAllUsers(); // Перезагружаем список
                } else {
                    alert('Ошибка удаления: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при удалении пользователя:', error);
                alert('Ошибка при удалении пользователя');
            }
        }

        // Редактирование пользователя (заглушка)
        function editUser(email, institute) {
            alert(`Редактирование пользователя ${email} из ${institute} (функция в разработке)`);
        }

        // Поиск пользователей
        const searchElement = document.getElementById('search');
        if (searchElement) {
            searchElement.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            const rows = document.querySelectorAll('.admin-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });
        }

        // Обработка импорта файла
        const uploadForm = document.getElementById('uploadForm');
        if (uploadForm) {
            uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const institute = document.getElementById('instituteSelect').value;
            formData.append('institute', institute);
            
            try {
                const response = await fetch(`${API_BASE}/workers/import`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Импорт завершён успешно');
                    loadAllUsers(); // Перезагружаем список
                } else {
                    alert('Ошибка импорта: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (err) {
                alert('Ошибка при импорте файла');
                console.error(err);
            }
        });
        }

        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function () {
                const fileNameSpan = document.getElementById('fileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : 'Файл не выбран';
                }
            });
        }

        // Загружаем данные при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
        });

        // Проверка доступа администратора
        async function checkAdminAccess() {
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                alert('Для доступа к админ-панели необходимо авторизоваться');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/user-info`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    alert('Ошибка проверки авторизации');
                    window.location.href = 'index.html';
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === 'Ok' && data.role === 'admin') {
                    // Пользователь администратор, загружаем данные
                    loadAllUsers();
                    loadDepartments('giredmet');
                    // Обновляем header после успешной проверки
                    updateHeaderButtons();
                } else {
                    alert('Доступ запрещен. Требуются права администратора.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Ошибка при проверке роли:', error);
                alert('Ошибка проверки доступа');
                window.location.href = 'index.html';
            }
        }

        // Получение информации о текущем пользователе
        async function getCurrentUserInfo() {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) return null;
            
            try {
                const response = await fetch(`${API_BASE}/auth/user-info`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('API user-info недоступен');
                    return null;
                }
                
                const data = await response.json();
                if (data.status === 'Ok') {
                    return { email: data.email, role: data.role };
                }
                
                return null;
            } catch (error) {
                console.error('Ошибка получения информации о пользователе:', error);
                return null;
            }
        }

        // Обновление header с информацией о пользователе
        async function updateHeaderButtons() {
            const authToken = localStorage.getItem('authToken');
            const headerRight = document.querySelector('.header-right');
            
            if (!headerRight) return;
            
            if (authToken) {
                try {
                    const userInfo = await getCurrentUserInfo();
                    
                    if (userInfo) {
                        // Форматируем роль для отображения
                        let roleDisplay = '';
                        switch (userInfo.role) {
                            case 'admin':
                                roleDisplay = 'Администратор';
                                break;
                            case 'user':
                                roleDisplay = 'Пользователь';
                                break;
                            default:
                                roleDisplay = userInfo.role;
                        }
                        
                        headerRight.innerHTML = `
                            <div class="user-info">
                                <span class="user-email">${userInfo.email}</span>
                                <span class="user-role">${roleDisplay}</span>
                            </div>
                            <button class="btn-primary" onclick="logout()">Выйти</button>
                        `;
                    } else {
                        headerRight.innerHTML = `
                            <span class="user-info">Авторизован</span>
                            <button class="btn-primary" onclick="logout()">Выйти</button>
                        `;
                    }
                } catch (error) {
                    console.error('Ошибка обновления header:', error);
                    headerRight.innerHTML = `
                        <span class="user-info">Авторизован</span>
                        <button class="btn-primary" onclick="logout()">Выйти</button>
                    `;
                }
            } else {
                headerRight.innerHTML = `
                    <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
                `;
            }
        }

        // Выход из системы
        function logout() {
            localStorage.removeItem('authToken');
            window.location.reload();
        }

        // Редактирование отдела
        async function editDepartment(name, institute) {
            currentEditingDepartment = name;
            currentEditingInstitute = institute;
            
            try {
                // Загружаем данные отдела (секции)
                const response = await fetch(`${API_BASE}/departments/${encodeURIComponent(name)}?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                // Заполняем форму
                document.getElementById('editDeptName').value = name;
                
                // Очищаем список секций и добавляем существующие
                const editSubdepartmentsList = document.getElementById('editSubdepartmentsList');
                editSubdepartmentsList.innerHTML = '';
                
                if (data.status === 'Ok' && data.sections) {
                    data.sections.forEach(section => {
                        const subdepartmentDiv = document.createElement('div');
                        subdepartmentDiv.className = 'subdepartment-field';
                        subdepartmentDiv.innerHTML = `
                            <input type="text" placeholder="Название подотдела" class="form-input subdepartment-input" value="${section.name}">
                            <button type="button" class="remove-subdepartment-btn" onclick="removeSubdepartmentField(this)">
                                <span>−</span> Удалить
                            </button>
                        `;
                        editSubdepartmentsList.appendChild(subdepartmentDiv);
                    });
                }
                
                openModal('editDepartmentModal');
            } catch (error) {
                console.error('Ошибка загрузки данных отдела:', error);
                alert('Ошибка загрузки данных отдела');
            }
        }

        // Сохранение изменений отдела
        async function saveDepartmentChanges() {
            if (!currentEditingDepartment || !currentEditingInstitute) {
                alert('Ошибка: данные отдела не загружены');
                return;
            }

            const newName = document.getElementById('editDeptName').value.trim();
            if (!newName) {
                alert('Пожалуйста, введите название отдела');
                return;
            }

            // Собираем подотделы
            const subdepartmentInputs = document.querySelectorAll('#editSubdepartmentsList .subdepartment-input');
            const sections = Array.from(subdepartmentInputs)
                .map(input => input.value.trim())
                .filter(value => value.length > 0);

            const requestData = {
                name: newName,
                sections: sections
            };

            console.log('Отправляем данные для обновления отдела:', requestData);

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Для редактирования отдела необходимо авторизоваться');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(currentEditingInstitute)}&department=${encodeURIComponent(currentEditingDepartment)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                console.log('Ответ сервера:', result);

                if (result.status === 'Ok') {
                    alert('Отдел успешно обновлен');
                    closeModal('editDepartmentModal');
                    // Перезагружаем список отделов
                    loadDepartments(currentEditingInstitute);
                } else {
                    alert('Ошибка при обновлении отдела: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при обновлении отдела:', error);
                alert('Ошибка при обновлении отдела: ' + error.message);
            }
        }

        // Удаление отдела
        function deleteDepartment(name, institute) {
            currentDeletingDepartment = name;
            currentDeletingInstitute = institute;
            
            // Обновляем текст подтверждения
            document.getElementById('deptNameToDelete').textContent = name;
            
            openModal('deleteDepartmentModal');
        }

        // Подтверждение удаления отдела
        async function confirmDepartmentDeletion() {
            if (!currentDeletingDepartment || !currentDeletingInstitute) {
                alert('Ошибка: данные отдела не загружены');
                return;
            }

            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Для удаления отдела необходимо авторизоваться');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(currentDeletingInstitute)}&department=${encodeURIComponent(currentDeletingDepartment)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();
                console.log('Ответ сервера:', result);

                if (result.status === 'Ok') {
                    alert('Отдел успешно удален');
                    closeModal('deleteDepartmentModal');
                    // Перезагружаем список отделов
                    loadDepartments(currentDeletingInstitute);
                } else {
                    alert('Ошибка при удалении отдела: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при удалении отдела:', error);
                alert('Ошибка при удалении отдела: ' + error.message);
            }

            // Очищаем переменные
            currentDeletingDepartment = null;
            currentDeletingInstitute = null;
        }

    </script>
</body>

</html>
