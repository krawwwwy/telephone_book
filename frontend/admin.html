<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="Росатом" class="logo">
            <span class="company-name">РОСАТОМ</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">Телефонный справочник</h1>
        </div>
        <div class="header-right">
            <a href="admin.html" class="btn-primary">
                Админ-панель
            </a>
            <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
        </div>
    </header>

    <div class="admin-container">
        <button class="btn-secondary" onclick="window.history.back()">Вернуться</button>
        <h1>Панель Администратора</h1>
        <div class="admin-buttons">
            <button class="add-btn" onclick="openModal('addUserModal')">Создать пользователя</button>
            <button class="add-btn" onclick="openModal('addDepartmentModal')">Добавить отдел</button>
        </div>

        <div class="edit-departments-section">
            <h2>Редактирование отделов</h2>
            <div class="division-tabs">
                <button class="division-tab active" data-division="giredmet">Гиредмет</button>
                <button class="division-tab" data-division="graphite">Графит</button>
            </div>

            <div class="departments-editor">
                <div class="departments-list" id="departmentsList"></div>
                <div class="department-actions">
                    <button class="edit-btn" id="editDeptBtn">Редактировать</button>
                    <button class="delete-btn" id="deleteDeptBtn">Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Если обнаружили неточности, напишите на почту it_rosatom@mail.ru
    </footer>

    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h2>Добавление пользователя</h2>
            <p class="modal-subtitle">Введите учетные данные</p>

            <input type="text" placeholder="Логин" class="auth-input">
            <input type="password" placeholder="Пароль" class="auth-input" autocomplete="new-password">

            <div class="role-selection">
                <p class="role-title">Выберите роль:</p>
                <div class="role-options">
                    <label class="role-option">
                        <input type="radio" name="userRole" value="user" checked>
                        <span class="role-checkmark"></span>
                        <span class="role-label">Пользователь</span>
                    </label>

                    <label class="role-option">
                        <input type="radio" name="userRole" value="admin">
                        <span class="role-checkmark"></span>
                        <span class="role-label">Администратор</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('addUserModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="submitUser()">Создать</button>
            </div>
        </div>
    </div>

    <div id="addDepartmentModal" class="modal">
        <div class="modal-content">
            <h2>Добавление отдела</h2>
            <p class="modal-subtitle">Заполните поля</p>
            <div class="form-group">
                <input type="text" placeholder="Название отдела*" class="form-input" required>
            </div>

            <div class="form-group">
                <input type="text" placeholder="Институт*" class="form-input" required>
            </div>

            <div class="subdepartments-section">
                <div class="section-header">
                    <h3>Подотделы (необязательно)</h3>
                    <button type="button" class="add-subdepartment-btn" onclick="addSubdepartmentField()">
                        <span>+</span> Добавить подотдел
                    </button>
                </div>

                <div class="subdepartments-list" id="subdepartmentsList">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('addDepartmentModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="submitDepartment()">Создать</button>
            </div>
        </div>
    </div>

    <div id="editDepartmentModal" class="modal">
        <div class="modal-content">
            <h2>Редактирование отдела</h2>

            <div class="form-group">
                <label>Название отдела:</label>
                <input type="text" id="editDeptName" class="form-input">
            </div>

            <div class="subdepartments-section">
                <div class="section-header">
                    <h3>Подотделы</h3>
                    <button type="button" class="add-subdepartment-btn" onclick="addSubdepartmentField(true)">
                        <span>+</span> Добавить подотдел
                    </button>
                </div>

                <div class="subdepartments-list" id="editSubdepartmentsList"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('editDepartmentModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="saveDepartmentChanges()">Сохранить</button>
            </div>
        </div>
    </div>

    <div id="deleteDepartmentModal" class="modal">
        <div class="modal-content">
            <h2>Удаление отдела</h2>
            <p id="deleteDeptConfirmText">Вы уверены, что хотите удалить отдел "<span id="deptNameToDelete"></span>"?
            </p>
            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal('deleteDepartmentModal')">Отмена</button>
                <button type="submit" class="submit-btn" onclick="confirmDepartmentDeletion()">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // Загрузка всех пользователей
        async function loadAllUsers() {
            try {
                const institutes = ['giredmet', 'grafit'];
                const tbody = document.querySelector('.admin-table tbody');
                tbody.innerHTML = '';
                
                for (const institute of institutes) {
                    const response = await fetch(`${API_BASE}/workers/all?institute=${institute}&department=`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'Ok' && data.users) {
                        data.users.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.name}</td>
                                <td>${user.department || ''}</td>
                                <td>${user.phone || ''}</td>
                                <td>${user.email || ''}</td>
                                <td>${user.cabinet || ''}</td>
                                <td>
                                    <button class="edit-btn" onclick="editUser('${user.email}', '${institute}')">Редактировать</button>
                                    <button class="delete-btn" onclick="deleteUser('${user.email}', '${institute}')">Удалить</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }

        // Удаление пользователя
        async function deleteUser(email, institute) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/workers?institute=${institute}&email=${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Пользователь удален');
                    loadAllUsers(); // Перезагружаем список
                } else {
                    alert('Ошибка удаления: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при удалении пользователя:', error);
                alert('Ошибка при удалении пользователя');
            }
        }

        // Редактирование пользователя (заглушка)
        function editUser(email, institute) {
            alert(`Редактирование пользователя ${email} из ${institute} (функция в разработке)`);
        }

        // Поиск пользователей
        document.getElementById('search').addEventListener('input', function () {
            const query = this.value.toLowerCase();
            const rows = document.querySelectorAll('.admin-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        // Обработка импорта файла
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const institute = document.getElementById('instituteSelect').value;
            formData.append('institute', institute);
            
            try {
                const response = await fetch(`${API_BASE}/workers/import`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Импорт завершён успешно');
                    loadAllUsers(); // Перезагружаем список
                } else {
                    alert('Ошибка импорта: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (err) {
                alert('Ошибка при импорте файла');
                console.error(err);
            }
        });

        document.getElementById('fileInput').addEventListener('change', function () {
            const fileNameSpan = document.getElementById('fileName');
            fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : 'Файл не выбран';
        });

        function openImportModal() {
            document.getElementById("importModal").style.display = "flex";
        }

        function closeImportModal() {
            document.getElementById("importModal").style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target === document.getElementById("importModal")) {
                closeImportModal();
            }
        };

        // Загружаем данные при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminAccess();
        });

        // Проверка доступа администратора
        async function checkAdminAccess() {
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                alert('Для доступа к админ-панели необходимо авторизоваться');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/user-info`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    alert('Ошибка проверки авторизации');
                    window.location.href = 'index.html';
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === 'Ok' && data.role === 'admin') {
                    // Пользователь администратор, загружаем данные
                    loadAllUsers();
                } else {
                    alert('Доступ запрещен. Требуются права администратора.');
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Ошибка при проверке роли:', error);
                alert('Ошибка проверки доступа');
                window.location.href = 'index.html';
            }
        }

    </script>
</body>

</html>
