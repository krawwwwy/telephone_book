<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="–†–æ—Å–∞—Ç–æ–º" class="logo">
            <span class="company-name">–†–û–°–ê–¢–û–ú</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</h1>
        </div>

        <div class="header-right">
            <a href="admin.html" class="btn-primary">
                –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            </a>
            <button class="btn-primary" onclick="location.href='login.html'">–í–æ–π—Ç–∏</button>
        </div>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="division-links">
                <a href="#" id="link-giredmet" onclick="switchDivision('giredmet')">–ì–∏—Ä–µ–¥–º–µ—Ç</a> /
                <a href="#" id="link-grafit" onclick="switchDivision('grafit')">–ì—Ä–∞—Ñ–∏—Ç</a>
            </div>
            <div id="division-button-container" style="margin-bottom: 20px; display: none;">
                <button class="btn-secondary" id="current-division-btn">–í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</button>
            </div>

            <ul class="department-list" id="department-list">
            </ul>
        </aside>
        <section class="center-panel">
            <h2 class="header-text">–¢–µ–ª–µ—Ñ–æ–Ω—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±</h1>
                <div class="emergency-table-wrapper">
                    <table class="emergency-table">
                        <thead>
                            <tr>
                                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="emergency-services">
                            <!-- –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ -->
                        </tbody>
                    </table>
                </div>
        </section>
        
        <aside class="right-sidebar">
            <div class="birthday-panel">
                <h3>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –î–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è!</h3>
                <div class="birthday-photo-container">
                    <img src="images/person.jpg" alt="–§–æ—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞" class="birthday-photo" id="birthdayPhoto">
                </div>
                <div class="birthday-info">
                    <div class="birthday-name" id="birthdayName">–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á</div>
                </div>
            </div>
            
            <div class="birthday-section">
                <h3 id="birthday-section-title">–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è</h3>
                <div class="birthday-today">
                    <h4>–°–µ–≥–æ–¥–Ω—è</h4>
                    <div id="birthday-today" class="birthday-list">
                        <!-- –î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è -->
                    </div>
                </div>
                <div class="birthday-tomorrow">
                    <h4>–ó–∞–≤—Ç—Ä–∞</h4>
                    <div id="birthday-tomorrow" class="birthday-list">
                        <!-- –î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è –∑–∞–≤—Ç—Ä–∞ -->
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –æ—Ç–¥–µ–ª–æ–≤ –∏ —Å–µ–∫—Ü–∏–π
        const departmentsCache = {
            giredmet: null,
            grafit: null
        };
        const sectionsCache = {};
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
        let currentInstitute = 'giredmet'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        // –ó–∞–≥—Ä—É–∑–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±
        async function loadEmergencyServices() {
            try {
                const response = await fetch(`${API_BASE}/emergency`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.services) {
                    const tbody = document.getElementById('emergency-services');
                    tbody.innerHTML = '';
                    
                    data.services.forEach(service => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${service.name}</td>
                            <td>${service.phone_number}</td>
                            <td>${service.email || 'N/A'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    console.log('–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞ API:', data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è
        async function loadBirthdays(institute = null) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∏—Ç—É—Ç –∏–ª–∏ —Ç–µ–∫—É—â–∏–π
                const targetInstitute = institute || currentInstitute;
                
                console.log('Loading birthdays for institute:', targetInstitute);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
                const titleElement = document.getElementById('birthday-section-title');
                if (titleElement) {
                    titleElement.textContent = `–î–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è (${capitalize(targetInstitute)})`;
                }
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è
                const todayResponse = await fetch(`${API_BASE}/birthday/today?institute=${targetInstitute}`);
                
                let todayUsers = [];
                try {
                    const todayText = await todayResponse.text();
                    console.log('Today response text:', todayText);
                    
                    if (todayText.trim()) {
                        const todayData = JSON.parse(todayText);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤ (—É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç) –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å –æ—à–∏–±–∫–æ–π
                        if (Array.isArray(todayData)) {
                            todayUsers = todayData;
                        } else if (todayData.status === 'Error') {
                            console.error('Birthday API error:', todayData.error);
                            todayUsers = [];
                        } else {
                            console.warn('Unexpected birthday response format:', todayData);
                            todayUsers = [];
                        }
                    }
                } catch (parseError) {
                    console.error('Error parsing today response:', parseError);
                    todayUsers = [];
                }
                
                console.log('Today birthday users:', todayUsers);
                
                if (Array.isArray(todayUsers)) {
                    const todayDiv = document.getElementById('birthday-today');
                    console.log('Today div element:', todayDiv);
                    
                    todayDiv.innerHTML = '';
                    
                    console.log('Number of users with birthday today:', todayUsers.length);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∏ —Å–µ–≥–æ–¥–Ω—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –≤ –≥–ª–∞–≤–Ω–æ–π –ø–∞–Ω–µ–ª–∏
                    if (todayUsers.length > 0) {
                        const mainUser = todayUsers[0];
                        const mainUserName = `${mainUser.surname} ${mainUser.name} ${mainUser.middle_name || ''}`.trim();
                        console.log('Main birthday user:', mainUserName);
                        
                        document.getElementById('birthdayName').textContent = mainUserName;
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ñ–æ—Ç–æ –µ—Å–ª–∏ –µ—Å—Ç—å API
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ—Ö –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–æ–≤ –≤ —Å–ø–∏—Å–∫–µ
                    todayUsers.forEach((user, index) => {
                        const fullName = `${user.surname} ${user.name} ${user.middle_name || ''}`.trim();
                        console.log(`Adding birthday user ${index + 1}:`, fullName);
                        
                        const userDiv = document.createElement('div');
                        userDiv.className = 'birthday-user';
                        userDiv.innerHTML = `${fullName}`;
                        todayDiv.appendChild(userDiv);
                    });
                    
                    // –ï—Å–ª–∏ –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
                    const birthdayPanel = document.querySelector('.birthday-panel');
                    if (todayUsers.length === 0) {
                        birthdayPanel.style.display = 'none';
                        console.log('Hiding birthday panel - no users');
                    } else {
                        birthdayPanel.style.display = 'block';
                        console.log('Showing birthday panel -', todayUsers.length, 'users');
                    }
                } else {
                    console.log('Invalid today birthday response - not an array:', todayUsers);
                }

                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è –∑–∞–≤—Ç—Ä–∞
                const tomorrowResponse = await fetch(`${API_BASE}/birthday/tomorrow?institute=${targetInstitute}`);
                
                let tomorrowUsers = [];
                try {
                    const tomorrowText = await tomorrowResponse.text();
                    console.log('Tomorrow response text:', tomorrowText);
                    
                    if (tomorrowText.trim()) {
                        const tomorrowData = JSON.parse(tomorrowText);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤ (—É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç) –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å –æ—à–∏–±–∫–æ–π
                        if (Array.isArray(tomorrowData)) {
                            tomorrowUsers = tomorrowData;
                        } else if (tomorrowData.status === 'Error') {
                            console.error('Tomorrow birthday API error:', tomorrowData.error);
                            tomorrowUsers = [];
                        } else {
                            console.warn('Unexpected tomorrow response format:', tomorrowData);
                            tomorrowUsers = [];
                        }
                    }
                } catch (parseError) {
                    console.error('Error parsing tomorrow response:', parseError);
                    tomorrowUsers = [];
                }
                
                console.log('Tomorrow birthday users:', tomorrowUsers);
                
                if (Array.isArray(tomorrowUsers)) {
                    const tomorrowDiv = document.getElementById('birthday-tomorrow');
                    console.log('Tomorrow div element:', tomorrowDiv);
                    
                    tomorrowDiv.innerHTML = '';
                    
                    console.log('Number of users with birthday tomorrow:', tomorrowUsers.length);
                    
                    tomorrowUsers.forEach((user, index) => {
                        const fullName = `${user.surname} ${user.name} ${user.middle_name || ''}`.trim();
                        console.log(`Adding tomorrow birthday user ${index + 1}:`, fullName);
                        
                        const userDiv = document.createElement('div');
                        userDiv.className = 'birthday-user';
                        userDiv.innerHTML = `${fullName}`;
                        tomorrowDiv.appendChild(userDiv);
                    });
                } else {
                    console.log('Invalid tomorrow birthday response - not an array:', tomorrowUsers);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–¥–µ–ª–æ–≤ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        async function loadDepartments(institute) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
                if (departmentsCache[institute]) {
                    console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –æ—Ç–¥–µ–ª–æ–≤ –¥–ª—è ${institute}`);
                    renderDepartments(departmentsCache[institute], institute);
                    return;
                }

                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                console.log(`–û—Ç–¥–µ–ª—ã –¥–ª—è ${institute}:`, data);
                
                if (data.status === 'Ok' && data.departments) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    departmentsCache[institute] = data.departments;
                    renderDepartments(data.departments, institute);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª–æ–≤:', data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª–æ–≤:', error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ç–¥–µ–ª–æ–≤
        function renderDepartments(departments, institute) {
            const list = document.getElementById('department-list');
            list.innerHTML = '';

            departments.forEach(dept => {
                const li = document.createElement('li');
                li.className = 'department-item';
                li.innerHTML = `<span class="department-name">${dept.name}</span>`;
                
                // –í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                li.querySelector('.department-name').onclick = () => {
                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}`;
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É —Å—Ä–∞–∑—É, –Ω–æ —Å–µ–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É
                const arrow = document.createElement('span');
                arrow.className = 'department-arrow';
                arrow.innerHTML = ' ‚ñº';
                arrow.style.cursor = 'pointer';
                arrow.style.fontSize = '12px';
                arrow.style.marginLeft = '5px';
                arrow.style.color = '#999';
                li.querySelector('.department-name').appendChild(arrow);
                
                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Å–µ–∫—Ü–∏–π
                    const subList = document.createElement('ul');
                    subList.classList.add('subdepartment-list');
                    subList.style.display = 'none';
                li.appendChild(subList);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–¥–æ—Ç–¥–µ–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–µ–ª–∫—É)
                arrow.onclick = (e) => {
                    e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–¥–µ–ª–∞
                    
                    if (subList.style.display === 'none') {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏
                        loadDepartmentSections(dept, institute, subList, arrow);
                        subList.style.display = 'block';
                        arrow.innerHTML = ' ‚ñ≤';
                    } else {
                        subList.style.display = 'none';
                        arrow.innerHTML = ' ‚ñº';
                    }
                };

                list.appendChild(li);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ü–∏–π –æ—Ç–¥–µ–ª–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
        async function loadDepartmentSections(dept, institute, subList, arrow) {
            const cacheKey = `${institute}-${dept.name}`;
            
            console.log(`–ó–∞–≥—Ä—É–∂–∞—é —Å–µ–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–¥–µ–ª–∞: ${dept.name}`);
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å–µ–∫—Ü–∏–π
                if (sectionsCache[cacheKey]) {
                    console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à —Å–µ–∫—Ü–∏–π –¥–ª—è ${dept.name}`);
                    renderSections(sectionsCache[cacheKey], dept, institute, subList);
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                subList.innerHTML = '<li style="color: #999; font-style: italic;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
                
                const sectionsResponse = await fetch(`${API_BASE}/departments/${encodeURIComponent(dept.name)}?institute=${encodeURIComponent(institute)}`);
                const sectionsData = await sectionsResponse.json();
                
                console.log(`–°–µ–∫—Ü–∏–∏ –¥–ª—è ${dept.name}:`, sectionsData);
                
                if (sectionsData.status === 'Ok' && sectionsData.sections) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    sectionsCache[cacheKey] = sectionsData.sections;
                    renderSections(sectionsData.sections, dept, institute, subList);
                } else {
                    console.log(`–°–µ–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è ${dept.name}:`, sectionsData.error);
                    subList.innerHTML = '<li style="color: #999; font-style: italic;">–ü–æ–¥–æ—Ç–¥–µ–ª–æ–≤ –Ω–µ—Ç</li>';
                }
            } catch (err) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π –¥–ª—è –æ—Ç–¥–µ–ª–∞ ${dept.name}:`, err);
                subList.innerHTML = '<li style="color: #d32f2f; font-style: italic;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>';
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ–∫—Ü–∏–π
        function renderSections(sections, dept, institute, subList) {
            subList.innerHTML = '';
            
            if (sections.length === 0) {
                subList.innerHTML = '<li style="color: #999; font-style: italic;">–ü–æ–¥–æ—Ç–¥–µ–ª–æ–≤ –Ω–µ—Ç</li>';
                return;
            }

            sections.forEach(section => {
                const subLi = document.createElement('li');
                subLi.textContent = section.name;
                subLi.onclick = () => {
                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}&section=${encodeURIComponent(section.name)}`;
                };
                subList.appendChild(subLi);
            });
        }

        function capitalize(str) {
            if (!str) return '';
            const map = {
                giredmet: "–ì–∏—Ä–µ–¥–º–µ—Ç",
                grafit: "–ì—Ä–∞—Ñ–∏—Ç"
            };
            return map[str.toLowerCase()] || str.charAt(0).toUpperCase() + str.slice(1);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadEmergencyServices();
            loadBirthdays();
            loadDepartments();

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            async function getCurrentUserInfo() {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) return null;
                
                try {
                    const response = await fetch(`${API_BASE}/auth/user-info`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        console.warn('API user-info –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                        return null;
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'Ok' && data.email) {
                        return {
                            email: data.email,
                            role: data.role
                        };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
                    return null;
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ header —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            async function updateHeaderButtons() {
                const authToken = localStorage.getItem('authToken');
                const headerRight = document.querySelector('.header-right');
                
                if (!headerRight) return;
                
                if (authToken) {
                    try {
                        const userInfo = await getCurrentUserInfo();
                        
                        if (userInfo) {
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–æ–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            let roleDisplay = '';
                            switch (userInfo.role) {
                                case 'admin':
                                    roleDisplay = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                                    break;
                                case 'user':
                                    roleDisplay = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                                    break;
                                default:
                                    roleDisplay = '–ì–æ—Å—Ç—å';
                            }
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                            const adminPanelButton = userInfo.role === 'admin' 
                                ? `<a href="admin.html" class="btn-primary">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>`
                                : '';
                            
                            headerRight.innerHTML = `
                                <div class="user-info">
                                    <span class="user-email">${userInfo.email}</span>
                                    <span class="user-role">${roleDisplay}</span>
                                </div>
                                ${adminPanelButton}
                                <button class="btn-primary" onclick="logout()">–í—ã–π—Ç–∏</button>
                            `;
                        } else {
                            headerRight.innerHTML = `
                                <span class="user-info">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                                <button class="btn-primary" onclick="logout()">–í—ã–π—Ç–∏</button>
                            `;
                        }
                    } catch (error) {
                        console.error('Error updating header with user info:', error);
                        headerRight.innerHTML = `
                            <span class="user-info">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                            <button class="btn-primary" onclick="logout()">–í—ã–π—Ç–∏</button>
                        `;
                    }
                } else {
                    headerRight.innerHTML = `
                        <button class="btn-primary" onclick="location.href='login.html'">–í–æ–π—Ç–∏</button>
                    `;
                }
            }

            // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
            function logout() {
                localStorage.removeItem('authToken');
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
                location.reload();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º header –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateHeaderButtons();
            
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º –ì–∏—Ä–µ–¥–º–µ—Ç
            switchDivision('giredmet');
        });

        function switchDivision(name) {
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
            loadDepartments(name);

            const buttonContainer = document.getElementById('division-button-container');
            const divisionButton = document.getElementById('current-division-btn');

            buttonContainer.style.display = 'block';
            divisionButton.textContent = `–í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã ${capitalize(name)}`;
            divisionButton.onclick = () => {
                window.location.href = `division.html?division=${encodeURIComponent(name)}`;
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById('link-giredmet').classList.remove('active-division');
            document.getElementById('link-grafit').classList.remove('active-division');
            document.getElementById(`link-${name}`).classList.add('active-division');

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω—Å—Ç–∏—Ç—É—Ç –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
            currentInstitute = name;
            loadBirthdays(name);
        }
    </script>
</body>

</html>