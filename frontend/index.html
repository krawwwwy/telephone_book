<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Телефонный справочник</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="Росатом" class="logo">
            <span class="company-name">РОСАТОМ</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">Телефонный справочник</h1>
        </div>

        <div class="header-right">
            <a href="admin.html" class="btn-primary">
                Админ-панель
            </a>
            <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
        </div>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="division-links">
                <a href="#" id="link-giredmet" onclick="switchDivision('giredmet')">Гиредмет</a> /
                <a href="#" id="link-grafit" onclick="switchDivision('grafit')">Графит</a>
            </div>
            <div id="division-button-container" style="margin-bottom: 20px; display: none;">
                <button class="btn-secondary" id="current-division-btn">Все контакты</button>
            </div>

            <ul class="department-list" id="department-list">
            </ul>
            <button class="add-btn" onclick="openAddDepartmentModal()">Добавить отдел</button>
        </aside>
        <section class="center-panel">
            <h2 class="header-text">Телефоны экстренных служб</h1>
                <div class="emergency-table-wrapper">
                    <table class="emergency-table">
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Телефон</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="emergency-services">
                            <!-- Экстренные службы будут загружены с сервера -->
                        </tbody>
                    </table>
                </div>

                <h2 class="header-text">Дни рождения</h2>
                <div class="birthday-section">
                    <div class="birthday-today">
                        <h3>Сегодня</h3>
                        <div id="birthday-today" class="birthday-list">
                            <!-- Дни рождения сегодня -->
                        </div>
                    </div>
                    <div class="birthday-tomorrow">
                        <h3>Завтра</h3>
                        <div id="birthday-tomorrow" class="birthday-list">
                            <!-- Дни рождения завтра -->
                        </div>
                    </div>
                </div>
        </section>
    </main>

    <script>
        const API_BASE = 'http://localhost:8080';
        
        // Загрузка экстренных служб
        async function loadEmergencyServices() {
            try {
                const response = await fetch(`${API_BASE}/emergency`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.services) {
                    const tbody = document.getElementById('emergency-services');
                    tbody.innerHTML = '';
                    
                    data.services.forEach(service => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${service.name}</td>
                            <td>${service.phone_number}</td>
                            <td>${service.email || 'N/A'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    console.log('Экстренные службы не найдены или ошибка API:', data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки экстренных служб:', error);
            }
        }

        // Загрузка дней рождения
        async function loadBirthdays() {
            try {
                // Загрузка дней рождения сегодня
                const todayResponse = await fetch(`${API_BASE}/birthday/today`);
                const todayData = await todayResponse.json();
                
                if (todayData.status === 'Ok' && todayData.users) {
                    const todayDiv = document.getElementById('birthday-today');
                    todayDiv.innerHTML = '';
                    
                    todayData.users.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'birthday-user';
                        userDiv.innerHTML = `${user.name} - ${user.department}`;
                        todayDiv.appendChild(userDiv);
                    });
                }

                // Загрузка дней рождения завтра
                const tomorrowResponse = await fetch(`${API_BASE}/birthday/tomorrow`);
                const tomorrowData = await tomorrowResponse.json();
                
                if (tomorrowData.status === 'Ok' && tomorrowData.users) {
                    const tomorrowDiv = document.getElementById('birthday-tomorrow');
                    tomorrowDiv.innerHTML = '';
                    
                    tomorrowData.users.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'birthday-user';
                        userDiv.innerHTML = `${user.name} - ${user.department}`;
                        tomorrowDiv.appendChild(userDiv);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки дней рождения:', error);
            }
        }

        // Загрузка отделов с секциями
        async function loadDepartments(institute) {
            try {
                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                console.log(`Отделы для ${institute}:`, data);
                
                if (data.status === 'Ok' && data.departments) {
                    const list = document.getElementById('department-list');
                    list.innerHTML = '';
                    
                    // Загружаем секции для каждого отдела
                    for (const dept of data.departments) {
                        console.log(`Загружаю секции для отдела: ${dept.name}`);
                        try {
                            const sectionsResponse = await fetch(`${API_BASE}/departments/${encodeURIComponent(dept.name)}?institute=${encodeURIComponent(institute)}`);
                            const sectionsData = await sectionsResponse.json();
                            
                            console.log(`Секции для ${dept.name}:`, sectionsData);
                            
                            if (sectionsData.status === 'Ok' && sectionsData.sections) {
                                dept.sections = sectionsData.sections;
                            } else {
                                console.log(`Секции не найдены для ${dept.name}:`, sectionsData.error);
                                dept.sections = [];
                            }
                        } catch (err) {
                            console.error(`Ошибка загрузки секций для отдела ${dept.name}:`, err);
                            dept.sections = [];
                        }
                    }
                    
                    data.departments.forEach(dept => {
                        const li = document.createElement('li');
                        li.className = 'department-item';
                        li.innerHTML = `<span class="department-name">${dept.name}</span>`;
                        
                        if (dept.sections && dept.sections.length > 0) {
                            const subList = document.createElement('ul');
                            subList.classList.add('subdepartment-list');
                            subList.style.display = 'none';
                            
                            dept.sections.forEach(section => {
                                const subLi = document.createElement('li');
                                subLi.textContent = section.name;
                                subLi.onclick = () => {
                                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}&section=${encodeURIComponent(section.name)}`;
                                };
                                subList.appendChild(subLi);
                            });
                            
                            li.appendChild(subList);
                            li.querySelector('.department-name').onclick = () => {
                                subList.style.display = subList.style.display === 'none' ? 'block' : 'none';
                            };
                        } else {
                            li.onclick = () => {
                                window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}`;
                            };
                        }
                        
                        list.appendChild(li);
                    });
                } else {
                    console.error('Ошибка загрузки отделов:', data.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки отделов:', error);
            }
        }

        function capitalize(str) {
            if (!str) return '';
            const map = {
                giredmet: "Гиредмет",
                grafit: "Графит"
            };
            return map[str.toLowerCase()] || str.charAt(0).toUpperCase() + str.slice(1);
        }

        function openAddDepartmentModal() {
            // Функция для совместимости, можно реализовать позже
            alert('Функция добавления отдела доступна на других страницах');
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadEmergencyServices();
            loadBirthdays();
            
            // По умолчанию загружаем Гиредмет
            switchDivision('giredmet');
        });

        function switchDivision(name) {
            // Сначала загружаем отделы для выбранного института
            loadDepartments(name);

            const buttonContainer = document.getElementById('division-button-container');
            const divisionButton = document.getElementById('current-division-btn');

            buttonContainer.style.display = 'block';
            divisionButton.textContent = `Все контакты ${capitalize(name)}`;
            divisionButton.onclick = () => {
                window.location.href = `division.html?division=${encodeURIComponent(name)}`;
            };

            // Обновляем активную вкладку
            document.getElementById('link-giredmet').classList.remove('active-division');
            document.getElementById('link-grafit').classList.remove('active-division');
            document.getElementById(`link-${name}`).classList.add('active-division');
        }
    </script>
</body>

</html>