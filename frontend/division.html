<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Контакты института</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="Росатом" class="logo">
            <span class="company-name">РОСАТОМ</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">Телефонный справочник</h1>
        </div>
        <div class="header-right">
            <a href="admin.html" class="btn-primary">
                Админ-панель
            </a>
            <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
        </div>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="division-links">
                <a href="division.html?division=giredmet" id="link-giredmet">Гиредмет</a> /
                <a href="division.html?division=grafit" id="link-grafit">Графит</a>
            </div>

            <ul class="department-list" id="department-list">
            </ul>
        </aside>
        <section class="center-panel">
            <nav class="breadcrumbs" id="breadcrumbs">
            </nav>
            <button class="add-btn" onclick="openAddContactModal()">Добавить контакт</button>
            <button class="add-btn" onclick="openImportModal()">Импортировать</button>
            <h2 id="divisionTitle">Контакты</h2>
            <div class="search-wrapper">
                <input type="text" class="search-bar" id="search"
                    placeholder="Например: Иванов, Дарья, marina@gmail.com">
                <button class="search-icon-btn" onclick="handleSearchClick()"></button>
            </div>
            <div class="employee-table-wrapper">
                <div id="pagination-top" class="pagination-controls"></div>
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>ФИО</th>
                            <th>Телефон</th>
                            <th>Каб.</th>
                            <th>Email</th>
                            <th>Должность</th>
                            <th>Отдел</th>
                            <th>Ред.</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                    </tbody>
                </table>
                <div id="pagination-bottom" class="pagination-controls"></div>
            </div>
            <div id="results" class="search-results"></div>
        </section>




    </main>

    <footer class="footer">
        Если обнаружили неточности, напишите на почту it_rosatom@mail.ru
    </footer>

    <script>
        const API_BASE = 'http://localhost:8080';

        // Глобальный кэш для отделов и секций
        const departmentsCache = {
            giredmet: null,
            grafit: null
        };
        const sectionsCache = {};

        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const division = urlParams.get('division') || 'giredmet';

        // Загрузка всех сотрудников института
        async function loadAllWorkers() {
            console.log('=== НАЧАЛО loadAllWorkers ===');
            console.log('division:', division);
            
            // Показываем индикатор загрузки
            const tbody = document.querySelector('#contactsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                            Загрузка всех сотрудников института...
                        </td>
                    </tr>
                `;
            }
            
            try {
                const url = `${API_BASE}/workers/all?institute=${encodeURIComponent(division)}&department=`;
                console.log('Отправляю запрос к:', url);
                
                const response = await fetch(url, {
                    method: 'POST'
                });
                const data = await response.json();
                
                console.log('Ответ API всех сотрудников:', data);
                
                if (data.status === 'Ok' && data.users) {
                    if (!tbody) {
                        console.error('Не найден tbody таблицы сотрудников!');
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    console.log(`Найдено сотрудников: ${data.users.length}`);
                    
                    if (data.users.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                    В институте ${division === 'giredmet' ? 'Гиредмет' : 'Графит'} пока нет сотрудников
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.users.forEach(user => {
                        // Формируем полное имя из surname, name, middle_name
                        const fullName = `${user.surname} ${user.name} ${user.middle_name || ''}`.trim();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div style="display: flex; align-items: center;">
                                    <img src="${API_BASE}/workers/${encodeURIComponent(user.email)}/photo?institute=${encodeURIComponent(division)}" 
                                         alt="Фото" class="contact-photo" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="contact-photo-placeholder" style="display: none;">
                                        ${user.surname ? user.surname.charAt(0).toUpperCase() : '?'}
                                    </div>
                                    <a href="contact.html?email=${encodeURIComponent(user.email)}" class="fio-link" style="margin-left: 10px;">${fullName}</a>
                                </div>
                            </td>
                            <td>${user.phone_number || ''}</td>
                            <td>${user.cabinet || ''}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.position || ''}</td>
                            <td>${user.department || ''}</td>
                            <td class="actions-cell">
                                <div class="actions-wrapper">
                                    <span class="icon-edit" title="Редактировать" onclick="openEditUserModal('${user.email}', '${division}')"></span>
                                    <span class="icon-delete" title="Удалить" onclick="openDeleteUserModal('${user.email}', '${division}', '${fullName}')"></span>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    console.log('Сотрудники добавлены в таблицу');
                    
                    // Настраиваем пагинацию
                    paginateTable();
                } else {
                    console.error('Ошибка загрузки всех сотрудников:', data.error);
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f; font-style: italic;">
                                    Ошибка загрузки данных: ${data.error || 'Неизвестная ошибка'}
                                </td>
                            </tr>
                        `;
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки сотрудников:', error);
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f; font-style: italic;">
                                Ошибка соединения с сервером
                            </td>
                        </tr>
                    `;
                }
            }
            
            console.log('=== КОНЕЦ loadAllWorkers ===');
        }

        // Загрузка отделов для сайдбара с кэшированием
        async function loadDepartments(institute) {
            try {
                // Проверяем кэш
                if (departmentsCache[institute]) {
                    console.log(`Используем кэш отделов для ${institute}`);
                    renderDepartments(departmentsCache[institute], institute);
                    return;
                }

                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.departments) {
                    // Сохраняем в кэш
                    departmentsCache[institute] = data.departments;
                    renderDepartments(data.departments, institute);
                }
            } catch (error) {
                console.error('Ошибка загрузки отделов:', error);
            }
        }

        // Отрисовка отделов
        function renderDepartments(departments, institute) {
            const list = document.getElementById('department-list');
            list.innerHTML = '';

            departments.forEach(dept => {
                const li = document.createElement('li');
                li.classList.add('department-item');
                li.innerHTML = `<span class="department-name">${dept.name}</span>`;

                // Всегда делаем отдел кликабельным для перехода на страницу
                li.querySelector('.department-name').onclick = () => {
                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}`;
                };

                // Добавляем стрелку сразу, но секции загружаем только по клику
                const arrow = document.createElement('span');
                arrow.className = 'department-arrow';
                arrow.innerHTML = ' ▼';
                arrow.style.cursor = 'pointer';
                arrow.style.fontSize = '12px';
                arrow.style.marginLeft = '5px';
                arrow.style.color = '#999';
                li.querySelector('.department-name').appendChild(arrow);
                
                // Создаем пустой список секций
                    const subList = document.createElement('ul');
                    subList.classList.add('subdepartment-list');
                    subList.style.display = 'none';
                li.appendChild(subList);
                
                // Обработчик для раскрытия/скрытия подотделов (только на стрелку)
                arrow.onclick = (e) => {
                    e.stopPropagation(); // Предотвращаем переход на страницу отдела
                    
                    if (subList.style.display === 'none') {
                        // Загружаем секции только при первом раскрытии
                        loadDepartmentSections(dept, institute, subList, arrow);
                        subList.style.display = 'block';
                        arrow.innerHTML = ' ▲';
                    } else {
                        subList.style.display = 'none';
                        arrow.innerHTML = ' ▼';
                    }
                };

                list.appendChild(li);
            });
        }

        // Загрузка секций отдела по требованию
        async function loadDepartmentSections(dept, institute, subList, arrow) {
            const cacheKey = `${institute}-${dept.name}`;
            
            try {
                // Проверяем кэш секций
                if (sectionsCache[cacheKey]) {
                    console.log(`Используем кэш секций для ${dept.name}`);
                    renderSections(sectionsCache[cacheKey], dept, institute, subList);
                    return;
                }

                // Показываем индикатор загрузки
                subList.innerHTML = '<li style="color: #999; font-style: italic;">Загрузка...</li>';
                
                const sectionsResponse = await fetch(`${API_BASE}/departments/${encodeURIComponent(dept.name)}?institute=${encodeURIComponent(institute)}`);
                const sectionsData = await sectionsResponse.json();
                
                if (sectionsData.status === 'Ok' && sectionsData.sections) {
                    // Сохраняем в кэш
                    sectionsCache[cacheKey] = sectionsData.sections;
                    renderSections(sectionsData.sections, dept, institute, subList);
                } else {
                    // Нет секций
                    subList.innerHTML = '<li style="color: #999; font-style: italic;">Подотделов нет</li>';
                }
            } catch (err) {
                console.log(`Ошибка загрузки секций для отдела ${dept.name}:`, err);
                subList.innerHTML = '<li style="color: #d32f2f; font-style: italic;">Ошибка загрузки</li>';
            }
        }

        // Отрисовка секций
        function renderSections(sections, dept, institute, subList) {
            subList.innerHTML = '';
            
            if (sections.length === 0) {
                subList.innerHTML = '<li style="color: #999; font-style: italic;">Подотделов нет</li>';
                return;
            }

            sections.forEach(section => {
                const subLi = document.createElement('li');
                subLi.textContent = section.name;
                subLi.onclick = () => {
                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}&section=${encodeURIComponent(section.name)}`;
                };
                subList.appendChild(subLi);
            });
        }

        function switchDivision(name) {
            // Загружаем отделы для выбранного института
            loadDepartments(name);

            // Обновляем активную вкладку
            document.getElementById('link-giredmet').classList.remove('active-division');
            document.getElementById('link-grafit').classList.remove('active-division');
            document.getElementById(`link-${name}`).classList.add('active-division');
        }

        // Загрузка breadcrumbs
        function loadBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (!breadcrumbs) return;

            let html = `<a href="index.html">Главная</a>`;
            html += ` / ${capitalize(division)}`;
            breadcrumbs.innerHTML = html;
        }

        function capitalize(str) {
            if (!str) return '';
            const map = {
                giredmet: "Гиредмет",
                grafit: "Графит"
            };
            return map[str.toLowerCase()] || str.charAt(0).toUpperCase() + str.slice(1);
        }

        function openAddContactModal() {
            document.getElementById("addContactModal").style.display = "flex";
        }

        function closeAddContactModal() {
            document.getElementById("addContactModal").style.display = "none";
        }

        function openImportModal() {
            document.getElementById("importModal").style.display = "flex";
        }

        function closeImportModal() {
            document.getElementById("importModal").style.display = "none";
            
            // Очищаем форму
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.reset();
                
                // Сбрасываем текст имени файла
                const fileNameSpan = document.getElementById('fileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = 'Файл не выбран';
                }
                
                // Восстанавливаем кнопку если она была заблокирована
                const submitBtn = uploadForm.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.textContent = 'Импортировать';
                    submitBtn.disabled = false;
                }
            }
        }

        function handleSearchClick() {
            const input = document.querySelector('.search-bar');
            const value = input.value.trim();
            if (value) {
                // Поиск уже реализован через input event listener
                console.log(`Поиск: ${value}`);
            }
        }

        let contactRowToDelete = null;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Division page loaded with division:', division);
            
            const headerText = document.querySelector('#divisionTitle');
            if (headerText) {
                const newTitle = `Все контакты ${division === 'giredmet' ? 'Гиредмет' : 'Графит'}`;
                console.log('Setting header title to:', newTitle);
                headerText.textContent = newTitle;
            } else {
                console.error('Header element #divisionTitle not found');
            }
            
            loadBreadcrumbs();
            switchDivision(division);
            loadAllWorkers();
            paginateTable();
            
            // Обновляем header при загрузке страницы
            updateHeaderButtons();
            
            // Обновляем видимость кнопок действий
            updateActionButtons();

            // Обработка формы добавления контакта
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Получаем значения из полей формы по ID
                    const surname = document.getElementById('surname').value.trim();
                    const name = document.getElementById('name').value.trim();
                    const phoneNumber = document.getElementById('phoneNumber').value.trim();
                    const email = document.getElementById('email').value.trim();
                    
                    // Проверяем обязательные поля
                    if (!surname) {
                        alert('Пожалуйста, введите фамилию');
                        return;
                    }
                    if (!name) {
                        alert('Пожалуйста, введите имя');
                        return;
                    }
                    if (!phoneNumber) {
                        alert('Пожалуйста, введите рабочий телефон');
                        return;
                    }
                    if (!email) {
                        alert('Пожалуйста, введите email');
                        return;
                    }
                    
                    // Создаем FormData для отправки файла
                    const formData = new FormData();
                    formData.append('institute', division);
                    formData.append('surname', surname);
                    formData.append('name', name);
                    formData.append('middle_name', document.getElementById('middleName').value.trim() || '');
                    formData.append('email', email);
                    formData.append('phone_number', phoneNumber);
                    formData.append('cabinet', document.getElementById('cabinet').value.trim() || '');
                    formData.append('position', document.getElementById('position').value.trim() || '');
                    formData.append('department', document.getElementById('department').value.trim() || department || '');
                    formData.append('section', document.getElementById('section').value.trim() || section || '');
                    formData.append('description', document.getElementById('description').value.trim() || '');
                    
                    // Форматируем дату рождения
                    let birthDate = document.getElementById('birthDate').value;
                    if (birthDate) {
                        formData.append('birth_date', birthDate);
                    }
                    
                    // Добавляем фотографию если выбрана
                    const photoInput = document.getElementById('contactPhoto');
                    if (photoInput.files.length > 0) {
                        const file = photoInput.files[0];
                        // Проверяем размер файла (5 МБ)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Размер фотографии не должен превышать 5 МБ');
                            return;
                        }
                        formData.append('photo', file);
                    }
                    
                    console.log('Отправляем данные с фотографией');

                    // Проверяем наличие токена авторизации
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        alert('Для добавления контакта необходимо авторизоваться');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE}/workers/with-photo`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                                // НЕ устанавливаем Content-Type для FormData - браузер сделает это автоматически
                            },
                            body: formData
                        });
                        
                        const result = await response.json();
                        console.log('Ответ сервера:', result);
                        
                        if (result.status === 'Ok') {
                            alert('Контакт успешно добавлен');
                            closeAddContactModal();
                            loadAllWorkers();
                            e.target.reset();
                            removePhotoPreview(); // Очищаем превью фотографии
                        } else {
                            alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                        }
                    } catch (error) {
                        console.error('Ошибка при добавлении контакта:', error);
                        alert('Ошибка при добавлении контакта: ' + error.message);
                    }
                });
            }

            // Обработка импорта файла
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Проверяем наличие токена авторизации
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        alert('Для импорта необходимо авторизоваться');
                        window.location.href = 'login.html';
                        return;
                    }

                    // Проверяем выбран ли файл
                    const fileInput = document.getElementById('fileInput');
                    if (!fileInput.files.length) {
                        alert('Пожалуйста, выберите файл для импорта');
                        return;
                    }

                    // Проверяем тип файла
                    const file = fileInput.files[0];
                    const allowedTypes = [
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                        'application/vnd.ms-excel' // .xls
                    ];
                    
                    if (!allowedTypes.includes(file.type)) {
                        alert('Пожалуйста, выберите файл Excel (.xlsx или .xls)');
                        return;
                    }

                    const formData = new FormData(e.target);
                    formData.append('institute', division);

                    // Показываем индикацию загрузки
                    const submitBtn = e.target.querySelector('.submit-btn');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Импортируется...';
                    submitBtn.disabled = true;
                    
                    try {
                        const response = await fetch(`${API_BASE}/workers/import`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.status === 'Ok') {
                            alert('Импорт завершён успешно');
                            closeImportModal(); // Закрываем модальное окно
                            loadAllWorkers(); // Перезагружаем список работников
                        } else {
                            alert('Ошибка импорта: ' + (result.error || 'Неизвестная ошибка'));
                        }
                    } catch (err) {
                        alert('Ошибка при импорте файла: ' + err.message);
                        console.error(err);
                    } finally {
                        // Восстанавливаем кнопку
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }

            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function () {
            const fileNameSpan = document.getElementById('fileName');
                    if (fileNameSpan) {
            fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : 'Файл не выбран';
                    }
                });
            }

            // Поиск с дебаунсингом
            const searchInput = document.getElementById('search');
            let searchTimeout;
            
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const query = this.value;
                    
                    // Очищаем предыдущий таймер
                    clearTimeout(searchTimeout);
                    
                    if (query.length < 2) {
                        loadAllWorkers();
                        return;
                    }

                    // Показываем индикатор поиска
                    const tbody = document.querySelector('#contactsTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                                Поиск "${query}"...
                            </td>
                        </tr>
                    `;

                    // Устанавливаем новый таймер на 300мс
                    searchTimeout = setTimeout(() => {
                        fetch(`${API_BASE}/search?institute=${encodeURIComponent(division)}&department=&query=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                console.log('Результаты поиска:', data);
                                
                                tbody.innerHTML = '';
                                
                                if (data.status === 'Ok' && data.users && data.users.length > 0) {
                                    data.users.forEach(user => {
                                        // Формируем полное имя из surname, name, middle_name
                                        const fullName = `${user.surname} ${user.name} ${user.middle_name || ''}`.trim();
                                        
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>
                                                <div style="display: flex; align-items: center;">
                                                    <img src="${API_BASE}/workers/${encodeURIComponent(user.email)}/photo?institute=${encodeURIComponent(division)}" 
                                                         alt="Фото" class="contact-photo" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                    <div class="contact-photo-placeholder" style="display: none;">
                                                        ${user.surname ? user.surname.charAt(0).toUpperCase() : '?'}
                                                    </div>
                                                    <a href="contact.html?email=${encodeURIComponent(user.email)}" class="fio-link" style="margin-left: 10px;">${fullName}</a>
                                                </div>
                                            </td>
                                            <td>${user.phone_number || ''}</td>
                                            <td>${user.cabinet || ''}</td>
                                            <td>${user.email || ''}</td>
                                            <td>${user.position || ''}</td>
                                            <td>${user.department || ''}</td>
                                            <td class="actions-cell">
                                                <div class="actions-wrapper">
                                                    <span class="icon-edit" title="Редактировать"></span>
                                                    <span class="icon-delete" title="Удалить"></span>
                                                </div>
                                            </td>
                                        `;
                                        tbody.appendChild(row);
                                    });
                                    
                                    // Настраиваем пагинацию
                                    paginateTable();
                                } else {
                                    // Показываем сообщение о том, что работников не найдено
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td colspan="8" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                            Работников не найдено по запросу "${query}"
                                        </td>
                                    `;
                                    tbody.appendChild(row);
                                }
                            })
                            .catch(err => {
                                console.error('Ошибка поиска:', err);
                                // Показываем сообщение об ошибке
                                tbody.innerHTML = '';
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f; font-style: italic;">
                                        Ошибка поиска. Попробуйте еще раз.
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                    }, 300); // Задержка 300мс
                });
            }

            // Обновление видимости кнопок действий
            updateActionButtons();

            // Закрытие модальных окон при клике вне их
            window.onclick = function (event) {
                if (event.target === document.getElementById("addContactModal")) {
                    closeAddContactModal();
                }
                if (event.target === document.getElementById("importModal")) {
                    closeImportModal();
                }
                if (event.target === document.getElementById("editUserModal")) {
                    closeEditUserModal();
                }
                if (event.target === document.getElementById("deleteConfirmModal")) {
                    closeDeleteModal();
                }
            };
        });

        // Функции для работы с фотографиями
        function setupPhotoPreview() {
            const photoInput = document.getElementById('contactPhoto');
            if (photoInput) {
                photoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Проверяем размер файла
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Размер фотографии не должен превышать 5 МБ');
                            e.target.value = '';
                            return;
                        }
                        
                        // Проверяем тип файла
                        if (!file.type.startsWith('image/')) {
                            alert('Пожалуйста, выберите файл изображения');
                            e.target.value = '';
                            return;
                        }
                        
                        // Показываем превью
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.getElementById('photoPreview');
                            const previewImg = document.getElementById('previewImage');
                            
                            previewImg.src = e.target.result;
                            previewDiv.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }
        
        function removePhotoPreview() {
            const photoInput = document.getElementById('contactPhoto');
            const previewDiv = document.getElementById('photoPreview');
            
            if (photoInput) photoInput.value = '';
            if (previewDiv) previewDiv.style.display = 'none';
        }

        // Инициализируем превью фотографии
        setupPhotoPreview();

        // Получение информации о текущем пользователе
        async function getCurrentUserInfo() {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) return null;
            
            try {
                const response = await fetch(`${API_BASE}/auth/user-info`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('API user-info недоступен');
                    return null;
                }
                
                const data = await response.json();
                
                if (data.status === 'Ok' && data.email) {
                    return {
                        email: data.email,
                        role: data.role
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Ошибка при получении информации о пользователе:', error);
                return null;
            }
        }

        // Обновление header с информацией о пользователе
        async function updateHeaderButtons() {
            const authToken = localStorage.getItem('authToken');
            const headerRight = document.querySelector('.header-right');
            
            if (!headerRight) return;
            
            if (authToken) {
                try {
                    const userInfo = await getCurrentUserInfo();
                    
                    if (userInfo) {
                        // Форматируем роль для отображения
                        let roleDisplay = '';
                        switch (userInfo.role) {
                            case 'admin':
                                roleDisplay = 'Администратор';
                                break;
                            case 'user':
                                roleDisplay = 'Пользователь';
                                break;
                            default:
                                roleDisplay = 'Гость';
                        }
                        
                        // Показываем кнопку админ-панели только для администраторов
                        const adminPanelButton = userInfo.role === 'admin' 
                            ? `<a href="admin.html" class="btn-primary">Админ-панель</a>`
                            : '';
                        
                        headerRight.innerHTML = `
                            <div class="user-info">
                                <span class="user-email">${userInfo.email}</span>
                                <span class="user-role">${roleDisplay}</span>
                            </div>
                            ${adminPanelButton}
                            <button class="btn-primary" onclick="logout()">Выйти</button>
                        `;
                    } else {
                        headerRight.innerHTML = `
                            <span class="user-info">Авторизован</span>
                            <button class="btn-primary" onclick="logout()">Выйти</button>
                        `;
                    }
                } catch (error) {
                    console.error('Error updating header with user info:', error);
                    headerRight.innerHTML = `
                        <span class="user-info">Авторизован</span>
                        <button class="btn-primary" onclick="logout()">Выйти</button>
                    `;
                }
            } else {
                headerRight.innerHTML = `
                    <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
                `;
            }
        }

        // Функция выхода
        function logout() {
            localStorage.removeItem('authToken');
            alert('Вы вышли из системы. Страница будет обновлена.');
            location.reload();
        }

    </script>

    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddContactModal()">&times;</span>
            <h2>Добавление контакта</h2>
            <p class="modal-subtitle">Заполните поля</p>
            <form id="contactForm">
                <input type="text" placeholder="Фамилия" id="surname" required>
                <input type="text" placeholder="Имя" id="name" required>
                <input type="text" placeholder="Отчество (необязательно)" id="middleName">
                <input type="email" placeholder="Email" id="email" required>
                <input type="tel" placeholder="Рабочий телефон" id="phoneNumber" required>
                <input type="text" placeholder="Кабинет (необязательно)" id="cabinet">
                <input type="text" placeholder="Должность (необязательно)" id="position">
                <input type="text" placeholder="Отдел (необязательно)" id="department">
                <input type="text" placeholder="Подотдел (необязательно)" id="section">
                <input type="date" placeholder="Дата рождения (необязательно)" id="birthDate">
                <input type="text" placeholder="Описание (необязательно)" id="description">
                <div class="file-upload-wrapper">
                    <label for="contactPhoto" class="file-upload-label">
                        <span class="file-upload-text">Загрузить фотографию (необязательно)</span>
                        <span class="file-upload-hint">Максимум 5 МБ, форматы: JPG, PNG, GIF, WebP</span>
                    </label>
                    <input type="file" id="contactPhoto" accept="image/*" class="file-upload-input">
                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <img id="previewImage" alt="Предпросмотр фотографии">
                        <button type="button" class="remove-photo-btn" onclick="removePhotoPreview()">&times;</button>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddContactModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Добавить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeImportModal()">&times;</span>
            <h2>Импорт контактов</h2>
            <p class="modal-subtitle">Загрузите файл Excel с контактами</p>
            <div class="import-info">
                <p><strong>Требования к файлу:</strong></p>
                <ul>
                    <li>Формат: Excel (.xlsx или .xls)</li>
                    <li>Первая строка должна содержать заголовки</li>
                    <li>Обязательные поля: Фамилия, Имя, Email</li>
                </ul>
            </div>
            <form id="uploadForm" enctype="multipart/form-data" method="post">
                <div class="file-upload-wrapper">
                    <label for="fileInput" class="file-upload-label">Выбрать файл Excel</label>
                    <span id="fileName" class="file-name">Файл не выбран</span>
                    <input type="file" name="file" id="fileInput" accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeImportModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Импортировать</button>
                </div>
            </form>
        </div>
    </div>
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
            <h2>Удаление контакта</h2>
            <p class="modal-subtitle">Подтвердите удаление</p>

            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteModal()">Отмена</button>
                <button class="submit-btn" onclick="confirmDeleteUser()">Удалить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования пользователя -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditUserModal()">&times;</span>
            <h2>Редактировать сотрудника</h2>
            <form id="editUserForm">
                <input type="text" id="editUserSurname" placeholder="Фамилия" required>
                <input type="text" id="editUserName" placeholder="Имя" required>
                <input type="text" id="editUserMiddleName" placeholder="Отчество">
                <input type="email" id="editUserEmail" placeholder="Email" required>
                <input type="tel" id="editUserPhone" placeholder="Телефон" required>
                <input type="text" id="editUserCabinet" placeholder="Кабинет">
                <input type="text" id="editUserPosition" placeholder="Должность">
                <input type="text" id="editUserDepartment" placeholder="Отдел">
                <input type="text" id="editUserSection" placeholder="Подотдел">
                <input type="date" id="editUserBirthday" placeholder="Дата рождения">
                <textarea id="editUserDescription" placeholder="Описание" rows="3"></textarea>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeEditUserModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const rowsPerPage = 10;
        let currentPage = 1;

        function createPaginationControls(totalPages) {
            const containers = [
                document.getElementById("pagination-top"),
                document.getElementById("pagination-bottom")
            ];

            containers.forEach(container => {
                container.innerHTML = "";

                const prevBtn = document.createElement("button");
                prevBtn.textContent = "←";
                prevBtn.classList.add("page-btn");
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        paginateTable();
                    }
                };
                container.appendChild(prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    btn.classList.add("page-btn");
                    if (i === currentPage) btn.classList.add("active");

                    btn.onclick = () => {
                        currentPage = i;
                        paginateTable();
                    };
                    container.appendChild(btn);
                }

                const nextBtn = document.createElement("button");
                nextBtn.textContent = "→";
                nextBtn.classList.add("page-btn");
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        paginateTable();
                    }
                };
                container.appendChild(nextBtn);
            });
        }

        function paginateTable() {
            const table = document.querySelector(".employee-table tbody");
            if (!table) return;

            const rows = Array.from(table.querySelectorAll("tr"));
            const totalPages = Math.ceil(rows.length / rowsPerPage);

            rows.forEach((row, index) => {
                row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage)
                    ? ""
                    : "none";
            });

            createPaginationControls(totalPages);
        }

        window.addEventListener("DOMContentLoaded", () => {
            paginateTable();
        });

        // Переменные для редактирования пользователя
        let currentEditingUser = null;
        let currentEditingInstitute = null;

        // Переменные для удаления пользователя
        let currentDeletingEmail = null;
        let currentDeletingInstitute = null;
        let currentDeletingName = null;

        // Открытие модального окна удаления пользователя
        function openDeleteUserModal(email, institute, fullName) {
            currentDeletingEmail = email;
            currentDeletingInstitute = institute;
            currentDeletingName = fullName;
            
            // Обновляем текст подтверждения
            const modalSubtitle = document.querySelector('#deleteConfirmModal .modal-subtitle');
            if (modalSubtitle) {
                modalSubtitle.textContent = `Вы уверены, что хотите удалить контакт "${fullName}"?`;
            }
            
            document.getElementById('deleteConfirmModal').style.display = 'flex';
        }

        // Подтверждение удаления пользователя
        async function confirmDeleteUser() {
            if (!currentDeletingEmail || !currentDeletingInstitute) return;

            // Проверяем наличие токена авторизации
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Для удаления необходимо авторизоваться');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/workers?email=${encodeURIComponent(currentDeletingEmail)}&institute=${currentDeletingInstitute}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Сотрудник успешно удален');
                    closeDeleteModal();
                    // Перезагружаем список сотрудников
                    loadAllWorkers();
                } else {
                    alert('Ошибка при удалении: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при удалении сотрудника:', error);
                alert('Ошибка при удалении сотрудника');
            }
            
            // Очищаем переменные
            currentDeletingEmail = null;
            currentDeletingInstitute = null;
            currentDeletingName = null;
        }

        // Закрытие модального окна удаления
        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            currentDeletingEmail = null;
            currentDeletingInstitute = null;
            currentDeletingName = null;
        }

        // Открытие модального окна редактирования пользователя
        async function openEditUserModal(email, institute) {
            try {
                // Загружаем данные пользователя
                const response = await fetch(`${API_BASE}/workers/${encodeURIComponent(email)}?institute=${institute}`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.user) {
                    const user = data.user;
                    currentEditingUser = user;
                    currentEditingInstitute = institute;
                    
                    // Заполняем форму данными пользователя
                    document.getElementById('editUserSurname').value = user.surname || '';
                    document.getElementById('editUserName').value = user.name || '';
                    document.getElementById('editUserMiddleName').value = user.middle_name || '';
                    document.getElementById('editUserEmail').value = user.email || '';
                    document.getElementById('editUserPhone').value = user.phone_number || '';
                    document.getElementById('editUserCabinet').value = user.cabinet || '';
                    document.getElementById('editUserPosition').value = user.position || '';
                    document.getElementById('editUserDepartment').value = user.department || '';
                    document.getElementById('editUserSection').value = user.section || '';
                    document.getElementById('editUserDescription').value = user.description || '';
                    
                    // Форматируем дату рождения для input[type="date"]
                    if (user.birth_date && user.birth_date !== '0001-01-01T00:00:00Z') {
                        const birthDate = new Date(user.birth_date);
                        const formattedDate = birthDate.toISOString().split('T')[0];
                        document.getElementById('editUserBirthday').value = formattedDate;
                    } else {
                        document.getElementById('editUserBirthday').value = '';
                    }
                    
                    document.getElementById('editUserModal').style.display = 'flex';
                } else {
                    alert('Ошибка загрузки данных пользователя');
                }
            } catch (error) {
                console.error('Ошибка загрузки пользователя:', error);
                alert('Ошибка загрузки данных пользователя');
            }
        }

        // Закрытие модального окна редактирования пользователя
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            currentEditingUser = null;
            currentEditingInstitute = null;
        }

        // Обработчик формы редактирования пользователя
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditingUser || !currentEditingInstitute) {
                alert('Ошибка: данные пользователя не загружены');
                return;
            }

            // Проверяем наличие токена авторизации
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('Для редактирования необходимо авторизоваться');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const formData = {
                    institute: currentEditingInstitute,
                    old_email: currentEditingUser.email,
                    surname: document.getElementById('editUserSurname').value.trim(),
                    name: document.getElementById('editUserName').value.trim(),
                    middle_name: document.getElementById('editUserMiddleName').value.trim(),
                    email: document.getElementById('editUserEmail').value.trim(),
                    phone_number: document.getElementById('editUserPhone').value.trim(),
                    cabinet: document.getElementById('editUserCabinet').value.trim(),
                    position: document.getElementById('editUserPosition').value.trim(),
                    department: document.getElementById('editUserDepartment').value.trim(),
                    section: document.getElementById('editUserSection').value.trim(),
                    description: document.getElementById('editUserDescription').value.trim()
                };
                
                // Добавляем дату рождения если указана
                const birthDate = document.getElementById('editUserBirthday').value;
                if (birthDate) {
                    formData.birth_date = new Date(birthDate).toISOString();
                }
                
                console.log('Отправляем данные для обновления:', formData);
                
                const response = await fetch(`${API_BASE}/workers`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                console.log('Ответ сервера:', result);
                
                if (result.status === 'Ok') {
                    alert('Сотрудник успешно обновлен');
                    closeEditUserModal();
                    // Перезагружаем список сотрудников
                    loadAllWorkers();
                } else {
                    alert('Ошибка при обновлении: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при обновлении сотрудника:', error);
                alert('Ошибка при обновлении сотрудника: ' + error.message);
            }
        });

        // Обновление видимости кнопок действий
        function updateActionButtons() {
            const authToken = localStorage.getItem('authToken');
            const addContactBtn = document.querySelector('.add-btn[onclick="openAddContactModal()"]');
            const importBtn = document.querySelector('.add-btn[onclick="openImportModal()"]');
            
            if (addContactBtn && importBtn) {
                if (authToken) {
                    // Показываем кнопки для авторизованных пользователей
                    addContactBtn.style.display = 'inline-block';
                    importBtn.style.display = 'inline-block';
                } else {
                    // Скрываем кнопки для неавторизованных пользователей
                    addContactBtn.style.display = 'none';
                    importBtn.style.display = 'none';
                }
            }
        }

        // Сброс формы добавления контакта
    </script>

</body>

</html>
