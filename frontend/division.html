<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="–†–æ—Å–∞—Ç–æ–º" class="logo">
            <span class="company-name">–†–û–°–ê–¢–û–ú</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫</h1>
        </div>
        <div class="header-right">
            <a href="admin.html" class="btn-primary">
                –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            </a>
            <button class="btn-primary" onclick="location.href='login.html'">–í–æ–π—Ç–∏</button>
        </div>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="division-links">
                <a href="division.html?division=giredmet" id="link-giredmet">–ì–∏—Ä–µ–¥–º–µ—Ç</a> /
                <a href="division.html?division=grafit" id="link-grafit">–ì—Ä–∞—Ñ–∏—Ç</a>
            </div>

            <ul class="department-list" id="department-list">
            </ul>
        </aside>
        <section class="center-panel">
            <nav class="breadcrumbs" id="breadcrumbs">
            </nav>
            <button class="add-btn" onclick="openAddContactModal()">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
            <button class="add-btn" onclick="openImportModal()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <h2 id="divisionTitle">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
            <div class="search-wrapper">
                <input type="text" class="search-bar" id="search"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤, –î–∞—Ä—å—è, marina@gmail.com">
                <button class="search-icon-btn" onclick="handleSearchClick()"></button>
            </div>
            <div class="employee-table-wrapper">
                <div id="pagination-top" class="pagination-controls"></div>
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>–§–ò–û</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                            <th>–ö–∞–±.</th>
                            <th>Email</th>
                            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>–û—Ç–¥–µ–ª</th>
                            <th>–†–µ–¥.</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                    </tbody>
                </table>
                <div id="pagination-bottom" class="pagination-controls"></div>
            </div>
            <div id="results" class="search-results"></div>
        </section>




    </main>

    <footer class="footer">
        –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ –ø–æ—á—Ç—É it_rosatom@mail.ru
    </footer>

    <script>
        const API_BASE = 'http://localhost:8080';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–ª—è –æ—Ç–¥–µ–ª–æ–≤ –∏ —Å–µ–∫—Ü–∏–π
        const departmentsCache = {
            giredmet: null,
            grafit: null
        };
        const sectionsCache = {};

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const division = urlParams.get('division') || 'giredmet';

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
        async function loadAllWorkers() {
            console.log('=== –ù–ê–ß–ê–õ–û loadAllWorkers ===');
            console.log('division:', division);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const tbody = document.querySelector('#contactsTableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                            –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞...
                        </td>
                    </tr>
                `;
            }
            
            try {
                const url = `${API_BASE}/workers/all?institute=${encodeURIComponent(division)}&department=`;
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫:', url);
                
                const response = await fetch(url, {
                    method: 'POST'
                });
                const data = await response.json();
                
                console.log('–û—Ç–≤–µ—Ç API –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', data);
                
                if (data.status === 'Ok' && data.users) {
                    if (!tbody) {
                        console.error('–ù–µ –Ω–∞–π–¥–µ–Ω tbody —Ç–∞–±–ª–∏—Ü—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!');
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    console.log(`–ù–∞–π–¥–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${data.users.length}`);
                    
                    if (data.users.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                    –í –∏–Ω—Å—Ç–∏—Ç—É—Ç–µ ${division === 'giredmet' ? '–ì–∏—Ä–µ–¥–º–µ—Ç' : '–ì—Ä–∞—Ñ–∏—Ç'} –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.users.forEach(user => {
                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∞–º–∏–ª–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª—ã
                        const shortName = `${user.surname} ${user.name ? user.name.charAt(0) + '.' : ''}${user.middle_name ? user.middle_name.charAt(0) + '.' : ''}`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div style="display: flex; align-items: center;">
                                    <img src="${API_BASE}/workers/${encodeURIComponent(user.email)}/photo?institute=${encodeURIComponent(division)}" 
                                         alt="–§–æ—Ç–æ" class="contact-photo" 
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="contact-photo-placeholder" style="display: none;">
                                        ${user.surname ? user.surname.charAt(0).toUpperCase() : '?'}
                                    </div>
                                    <a href="contact.html?email=${encodeURIComponent(user.email)}" class="fio-link" style="margin-left: 10px;">${shortName}</a>
                                </div>
                            </td>
                            <td>${user.phone_number || ''}</td>
                            <td>${user.cabinet || ''}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.position || ''}</td>
                            <td>${user.department || ''}</td>
                            <td class="actions-cell">
                                <div class="actions-wrapper">
                                    <span class="icon-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onclick="openEditUserModal('${user.email}', '${division}')"></span>
                                    <span class="icon-delete" title="–£–¥–∞–ª–∏—Ç—å" onclick="openDeleteUserModal('${user.email}', '${division}', '${shortName}')"></span>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    console.log('–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É');
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                    paginateTable();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', data.error);
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f; font-style: italic;">
                                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                                </td>
                            </tr>
                        `;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f; font-style: italic;">
                                –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                            </td>
                        </tr>
                    `;
                }
            }
            
            console.log('=== –ö–û–ù–ï–¶ loadAllWorkers ===');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–¥–µ–ª–æ–≤ –¥–ª—è —Å–∞–π–¥–±–∞—Ä–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        async function loadDepartments(institute) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
                if (departmentsCache[institute]) {
                    console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –æ—Ç–¥–µ–ª–æ–≤ –¥–ª—è ${institute}`);
                    renderDepartments(departmentsCache[institute], institute);
                    return;
                }

                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.departments) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    departmentsCache[institute] = data.departments;
                    renderDepartments(data.departments, institute);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª–æ–≤:', error);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Ç–¥–µ–ª–æ–≤
        function renderDepartments(departments, institute) {
            const list = document.getElementById('department-list');
            list.innerHTML = '';

            departments.forEach(dept => {
                const li = document.createElement('li');
                li.classList.add('department-item');
                li.innerHTML = `<span class="department-name">${dept.name}</span>`;

                // –í—Å–µ–≥–¥–∞ –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                li.querySelector('.department-name').onclick = () => {
                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}`;
                };

                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É —Å—Ä–∞–∑—É, –Ω–æ —Å–µ–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É
                const arrow = document.createElement('span');
                arrow.className = 'department-arrow';
                arrow.innerHTML = ' ‚ñº';
                arrow.style.cursor = 'pointer';
                arrow.style.fontSize = '12px';
                arrow.style.marginLeft = '5px';
                arrow.style.color = '#999';
                li.querySelector('.department-name').appendChild(arrow);
                
                // –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Å–µ–∫—Ü–∏–π
                    const subList = document.createElement('ul');
                    subList.classList.add('subdepartment-list');
                    subList.style.display = 'none';
                li.appendChild(subList);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–¥–æ—Ç–¥–µ–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–µ–ª–∫—É)
                arrow.onclick = (e) => {
                    e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç–¥–µ–ª–∞
                    
                    if (subList.style.display === 'none') {
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–∫—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏
                        loadDepartmentSections(dept, institute, subList, arrow);
                        subList.style.display = 'block';
                        arrow.innerHTML = ' ‚ñ≤';
                    } else {
                        subList.style.display = 'none';
                        arrow.innerHTML = ' ‚ñº';
                    }
                };

                list.appendChild(li);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–∫—Ü–∏–π –æ—Ç–¥–µ–ª–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
        async function loadDepartmentSections(dept, institute, subList, arrow) {
            const cacheKey = `${institute}-${dept.name}`;
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Å–µ–∫—Ü–∏–π
                if (sectionsCache[cacheKey]) {
                    console.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à —Å–µ–∫—Ü–∏–π –¥–ª—è ${dept.name}`);
                    renderSections(sectionsCache[cacheKey], dept, institute, subList);
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                subList.innerHTML = '<li style="color: #999; font-style: italic;">–ó–∞–≥—Ä—É–∑–∫–∞...</li>';
                
                const sectionsResponse = await fetch(`${API_BASE}/departments/${encodeURIComponent(dept.name)}?institute=${encodeURIComponent(institute)}`);
                const sectionsData = await sectionsResponse.json();
                
                if (sectionsData.status === 'Ok' && sectionsData.sections) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    sectionsCache[cacheKey] = sectionsData.sections;
                    renderSections(sectionsData.sections, dept, institute, subList);
                } else {
                    // –ù–µ—Ç —Å–µ–∫—Ü–∏–π
                    subList.innerHTML = '<li style="color: #999; font-style: italic;">–ü–æ–¥–æ—Ç–¥–µ–ª–æ–≤ –Ω–µ—Ç</li>';
                }
            } catch (err) {
                console.log(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–∫—Ü–∏–π –¥–ª—è –æ—Ç–¥–µ–ª–∞ ${dept.name}:`, err);
                subList.innerHTML = '<li style="color: #d32f2f; font-style: italic;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</li>';
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ–∫—Ü–∏–π
        function renderSections(sections, dept, institute, subList) {
            subList.innerHTML = '';
            
            if (sections.length === 0) {
                subList.innerHTML = '<li style="color: #999; font-style: italic;">–ü–æ–¥–æ—Ç–¥–µ–ª–æ–≤ –Ω–µ—Ç</li>';
                return;
            }

            sections.forEach(section => {
                const subLi = document.createElement('li');
                subLi.textContent = section.name;
                subLi.onclick = () => {
                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}&section=${encodeURIComponent(section.name)}`;
                };
                subList.appendChild(subLi);
            });
        }

        function switchDivision(name) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–¥–µ–ª—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
            loadDepartments(name);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById('link-giredmet').classList.remove('active-division');
            document.getElementById('link-grafit').classList.remove('active-division');
            document.getElementById(`link-${name}`).classList.add('active-division');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ breadcrumbs
        function loadBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (!breadcrumbs) return;

            let html = `<a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>`;
            html += ` / ${capitalize(division)}`;
            breadcrumbs.innerHTML = html;
        }

        function capitalize(str) {
            if (!str) return '';
            const map = {
                giredmet: "–ì–∏—Ä–µ–¥–º–µ—Ç",
                grafit: "–ì—Ä–∞—Ñ–∏—Ç"
            };
            return map[str.toLowerCase()] || str.charAt(0).toUpperCase() + str.slice(1);
        }

        function openAddContactModal() {
            document.getElementById("addContactModal").style.display = "flex";
        }

        function closeAddContactModal() {
            document.getElementById("addContactModal").style.display = "none";
        }

        function openImportModal() {
            document.getElementById("importModal").style.display = "flex";
        }

        function closeImportModal() {
            document.getElementById("importModal").style.display = "none";
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.reset();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                const fileNameSpan = document.getElementById('fileName');
                if (fileNameSpan) {
                    fileNameSpan.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const submitBtn = document.getElementById('importSubmitBtn');
                const btnText = submitBtn.querySelector('.btn-text');
                if (submitBtn && btnText) {
                    btnText.innerHTML = 'üöÄ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å';
                    submitBtn.disabled = false;
                }
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                const progressDiv = document.getElementById('uploadProgress');
                const progressFill = document.querySelector('.progress-fill');
                if (progressDiv) {
                    progressDiv.style.display = 'none';
                }
                if (progressFill) {
                    progressFill.style.width = '0%';
                }
            }
        }

        function handleSearchClick() {
            const input = document.querySelector('.search-bar');
            const value = input.value.trim();
            if (value) {
                // –ü–æ–∏—Å–∫ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ input event listener
                console.log(`–ü–æ–∏—Å–∫: ${value}`);
            }
        }

        let contactRowToDelete = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Division page loaded with division:', division);
            
            const headerText = document.querySelector('#divisionTitle');
            if (headerText) {
                const newTitle = `–í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã ${division === 'giredmet' ? '–ì–∏—Ä–µ–¥–º–µ—Ç' : '–ì—Ä–∞—Ñ–∏—Ç'}`;
                console.log('Setting header title to:', newTitle);
                headerText.textContent = newTitle;
            } else {
                console.error('Header element #divisionTitle not found');
            }
            
            loadBreadcrumbs();
            switchDivision(division);
            loadAllWorkers();
            paginateTable();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º header –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            updateHeaderButtons();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
            updateActionButtons();

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
            const contactForm = document.getElementById('contactForm');
            if (contactForm) {
                contactForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –ø–æ ID
                    const surname = document.getElementById('surname').value.trim();
                    const name = document.getElementById('name').value.trim();
                    const phoneNumber = document.getElementById('phoneNumber').value.trim();
                    const email = document.getElementById('email').value.trim();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                    if (!surname) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é');
                        return;
                    }
                    if (!name) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
                        return;
                    }
                    if (!phoneNumber) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ä–∞–±–æ—á–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω');
                        return;
                    }
                    if (!email) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email');
                        return;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
                    const formData = new FormData();
                    formData.append('institute', division);
                    formData.append('surname', surname);
                    formData.append('name', name);
                    formData.append('middle_name', document.getElementById('middleName').value.trim() || '');
                    formData.append('email', email);
                    formData.append('phone_number', phoneNumber);
                    formData.append('cabinet', document.getElementById('cabinet').value.trim() || '');
                    formData.append('position', document.getElementById('position').value.trim() || '');
                    formData.append('department', document.getElementById('department').value.trim() || department || '');
                    formData.append('section', document.getElementById('section').value.trim() || section || '');
                    formData.append('description', document.getElementById('description').value.trim() || '');
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
                    let birthDate = document.getElementById('birthDate').value;
                    if (birthDate) {
                        formData.append('birth_date', birthDate);
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞
                    const photoInput = document.getElementById('contactPhoto');
                    if (photoInput.files.length > 0) {
                        const file = photoInput.files[0];
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (5 –ú–ë)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë');
                            return;
                        }
                        formData.append('photo', file);
                    }
                    
                    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π');

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        alert('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE}/workers/with-photo`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                                // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type –¥–ª—è FormData - –±—Ä–∞—É–∑–µ—Ä —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            },
                            body: formData
                        });
                        
                        const result = await response.json();
                        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                        
                        if (result.status === 'Ok') {
                            alert('–ö–æ–Ω—Ç–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
                            closeAddContactModal();
                            loadAllWorkers();
                            e.target.reset();
                            removePhotoPreview(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
                        } else {
                            alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', error);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞: ' + error.message);
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        alert('–î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                        window.location.href = 'login.html';
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω –ª–∏ —Ñ–∞–π–ª
                    const fileInput = document.getElementById('fileInput');
                    if (!fileInput.files.length) {
                        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
                        return;
                    }

                    const file = fileInput.files[0];
                    
                    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
                    const allowedTypes = [
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                        'application/vnd.ms-excel' // .xls
                    ];
                    
                    if (!allowedTypes.includes(file.type)) {
                        alert('‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª Excel (.xlsx –∏–ª–∏ .xls)');
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (10 –ú–ë)
                    const maxSize = 10 * 1024 * 1024; // 10 MB
                    if (file.size > maxSize) {
                        alert(`‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!\n\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10 –ú–ë\n–í–∞—à —Ñ–∞–π–ª: ${(file.size / 1024 / 1024).toFixed(2)} –ú–ë`);
                        return;
                    }

                    const formData = new FormData(e.target);
                    formData.append('institute', division);

                    // UI —ç–ª–µ–º–µ–Ω—Ç—ã
                    const submitBtn = document.getElementById('importSubmitBtn');
                    const btnText = submitBtn.querySelector('.btn-text');
                    const progressDiv = document.getElementById('uploadProgress');
                    const progressFill = document.querySelector('.progress-fill');
                    const progressText = document.querySelector('.progress-text');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    const originalBtnText = btnText.innerHTML;
                    btnText.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
                    submitBtn.disabled = true;
                    progressDiv.style.display = 'block';
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 90) progress = 90;
                        progressFill.style.width = progress + '%';
                    }, 200);
                    
                    try {
                        progressText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';
                        
                        const response = await fetch(`${API_BASE}/workers/import?institute=${encodeURIComponent(division)}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: formData
                        });

                        progressText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
                        const result = await response.json();
                        
                        // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                        clearInterval(progressInterval);
                        progressFill.style.width = '100%';
                        
                        if (result.status === 'Ok') {
                            progressText.textContent = '‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!';
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                            setTimeout(() => {
                                const importedCount = result.imported_count || '–ù–µ—Å–∫–æ–ª—å–∫–æ';
                                alert(`üéâ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!\n\nüìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${importedCount}\n\n‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.`);
                                closeImportModal();
                                loadAllWorkers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
                            }, 1000);
                        } else {
                            progressText.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ';
                            alert(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:\n\n${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
                        }
                    } catch (err) {
                        clearInterval(progressInterval);
                        progressText.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                        console.error('Import error:', err);
                        alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞:\n\n${err.message}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`);
                    } finally {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                        setTimeout(() => {
                            btnText.innerHTML = originalBtnText;
                            submitBtn.disabled = false;
                            progressDiv.style.display = 'none';
                            progressFill.style.width = '0%';
                        }, 2000);
                    }
                });
            }

            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function () {
            const fileNameSpan = document.getElementById('fileName');
                    if (fileNameSpan) {
            fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                    }
                });
            }

            // –ü–æ–∏—Å–∫ —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º
            const searchInput = document.getElementById('search');
            let searchTimeout;
            
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const query = this.value;
                    
                    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
                    clearTimeout(searchTimeout);
                    
                    if (query.length < 2) {
                        loadAllWorkers();
                        return;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–∏—Å–∫–∞
                    const tbody = document.querySelector('#contactsTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 20px; color: #666;">
                                –ü–æ–∏—Å–∫ "${query}"...
                            </td>
                        </tr>
                    `;

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–µ—Ä –Ω–∞ 300–º—Å
                    searchTimeout = setTimeout(() => {
                        fetch(`${API_BASE}/search?institute=${encodeURIComponent(division)}&department=&query=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:', data);
                                
                                tbody.innerHTML = '';
                                
                                if (data.status === 'Ok' && data.users && data.users.length > 0) {
                                    data.users.forEach(user => {
                                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∞–º–∏–ª–∏—é –∏ –∏–Ω–∏—Ü–∏–∞–ª—ã
                                        const shortName = `${user.surname} ${user.name ? user.name.charAt(0) + '.' : ''}${user.middle_name ? user.middle_name.charAt(0) + '.' : ''}`;
                                        
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>
                                                <div style="display: flex; align-items: center;">
                                                    <img src="${API_BASE}/workers/${encodeURIComponent(user.email)}/photo?institute=${encodeURIComponent(division)}" 
                                                         alt="–§–æ—Ç–æ" class="contact-photo" 
                                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                    <div class="contact-photo-placeholder" style="display: none;">
                                                        ${user.surname ? user.surname.charAt(0).toUpperCase() : '?'}
                                                    </div>
                                                    <a href="contact.html?email=${encodeURIComponent(user.email)}" class="fio-link" style="margin-left: 10px;">${shortName}</a>
                                                </div>
                                            </td>
                                            <td>${user.phone_number || ''}</td>
                                            <td>${user.cabinet || ''}</td>
                                            <td>${user.email || ''}</td>
                                            <td>${user.position || ''}</td>
                                            <td>${user.department || ''}</td>
                                            <td class="actions-cell">
                                                <div class="actions-wrapper">
                                                    <span class="icon-edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"></span>
                                                    <span class="icon-delete" title="–£–¥–∞–ª–∏—Ç—å"></span>
                                                </div>
                                            </td>
                                        `;
                                        tbody.appendChild(row);
                                    });
                                    
                                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                                    paginateTable();
                                } else {
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td colspan="8" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                            –†–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"
                                        </td>
                                    `;
                                    tbody.appendChild(row);
                                }
                            })
                            .catch(err => {
                                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                                tbody.innerHTML = '';
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td colspan="8" style="text-align: center; padding: 20px; color: #d32f2f; font-style: italic;">
                                        –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                    }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
            updateActionButtons();

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            window.onclick = function (event) {
                if (event.target === document.getElementById("addContactModal")) {
                    closeAddContactModal();
                }
                if (event.target === document.getElementById("importModal")) {
                    closeImportModal();
                }
                if (event.target === document.getElementById("editUserModal")) {
                    closeEditUserModal();
                }
                if (event.target === document.getElementById("deleteConfirmModal")) {
                    closeDeleteModal();
                }
            };
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
        function setupPhotoPreview() {
            const photoInput = document.getElementById('contactPhoto');
            if (photoInput) {
                photoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
                        if (file.size > 5 * 1024 * 1024) {
                            alert('–†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë');
                            e.target.value = '';
                            return;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                        if (!file.type.startsWith('image/')) {
                            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                            e.target.value = '';
                            return;
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.getElementById('photoPreview');
                            const previewImg = document.getElementById('previewImage');
                            
                            previewImg.src = e.target.result;
                            previewDiv.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }
        
        function removePhotoPreview() {
            const photoInput = document.getElementById('contactPhoto');
            const previewDiv = document.getElementById('photoPreview');
            
            if (photoInput) photoInput.value = '';
            if (previewDiv) previewDiv.style.display = 'none';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        setupPhotoPreview();

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function getCurrentUserInfo() {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) return null;
            
            try {
                const response = await fetch(`${API_BASE}/auth/user-info`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('API user-info –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return null;
                }
                
                const data = await response.json();
                
                if (data.status === 'Ok' && data.email) {
                    return {
                        email: data.email,
                        role: data.role
                    };
                }
                
                return null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
                return null;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ header —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        async function updateHeaderButtons() {
            const authToken = localStorage.getItem('authToken');
            const headerRight = document.querySelector('.header-right');
            
            if (!headerRight) return;
            
            if (authToken) {
                try {
                    const userInfo = await getCurrentUserInfo();
                    
                    if (userInfo) {
                        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–æ–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        let roleDisplay = '';
                        switch (userInfo.role) {
                            case 'admin':
                                roleDisplay = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
                                break;
                            case 'user':
                                roleDisplay = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                                break;
                            default:
                                roleDisplay = '–ì–æ—Å—Ç—å';
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
                        const adminPanelButton = userInfo.role === 'admin' 
                            ? `<a href="admin.html" class="btn-primary">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>`
                            : '';
                        
                        headerRight.innerHTML = `
                            <div class="user-info">
                                <span class="user-email">${userInfo.email}</span>
                                <span class="user-role">${roleDisplay}</span>
                            </div>
                            ${adminPanelButton}
                            <button class="btn-primary" onclick="logout()">–í—ã–π—Ç–∏</button>
                        `;
                    } else {
                        headerRight.innerHTML = `
                            <span class="user-info">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                            <button class="btn-primary" onclick="logout()">–í—ã–π—Ç–∏</button>
                        `;
                    }
                } catch (error) {
                    console.error('Error updating header with user info:', error);
                    headerRight.innerHTML = `
                        <span class="user-info">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                        <button class="btn-primary" onclick="logout()">–í—ã–π—Ç–∏</button>
                    `;
                }
            } else {
                headerRight.innerHTML = `
                    <button class="btn-primary" onclick="location.href='login.html'">–í–æ–π—Ç–∏</button>
                `;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            localStorage.removeItem('authToken');
            alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞.');
            location.reload();
        }

    </script>

    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddContactModal()">&times;</span>
            <h2>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h2>
            <p class="modal-subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è</p>
            <form id="contactForm">
                <input type="text" placeholder="–§–∞–º–∏–ª–∏—è" id="surname" required>
                <input type="text" placeholder="–ò–º—è" id="name" required>
                <input type="text" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="middleName">
                <input type="email" placeholder="Email" id="email" required>
                <input type="tel" placeholder="–†–∞–±–æ—á–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω" id="phoneNumber" required>
                <input type="text" placeholder="–ö–∞–±–∏–Ω–µ—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="cabinet">
                <input type="text" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="position">
                <input type="text" placeholder="–û—Ç–¥–µ–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="department">
                <input type="text" placeholder="–ü–æ–¥–æ—Ç–¥–µ–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="section">
                <input type="date" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="birthDate">
                <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" id="description">
                <div class="file-upload-wrapper">
                    <label for="contactPhoto" class="file-upload-label">
                        <span class="file-upload-text">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        <span class="file-upload-hint">–ú–∞–∫—Å–∏–º—É–º 5 –ú–ë, —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF, WebP</span>
                    </label>
                    <input type="file" id="contactPhoto" accept="image/*" class="file-upload-input">
                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <img id="previewImage" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏">
                        <button type="button" class="remove-photo-btn" onclick="removePhotoPreview()">&times;</button>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddContactModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="submit-btn">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeImportModal()">&times;</span>
            <h2>üì• –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h2>
            <p class="modal-subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª Excel —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞</p>
            
            <div class="import-info">
                <div class="info-section">
                    <h4>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–∞–π–ª—É:</h4>
                    <ul>
                        <li><strong>–§–æ—Ä–º–∞—Ç:</strong> Excel (.xlsx –∏–ª–∏ .xls)</li>
                        <li><strong>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä:</strong> 10 –ú–ë</li>
                        <li><strong>–°—Ç—Ä—É–∫—Ç—É—Ä–∞:</strong> –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤</li>
                    </ul>
                </div>
                
                <div class="info-section">
                    <h4>‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:</h4>
                    <ul>
                        <li>–§–∞–º–∏–ª–∏—è (surname)</li>
                        <li>–ò–º—è (name)</li>
                        <li>Email (email)</li>
                        <li>–†–∞–±–æ—á–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω (phone_number)</li>
                    </ul>
                </div>
                
                <div class="info-section">
                    <h4>üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:</h4>
                    <ul>
                        <li>–û—Ç—á–µ—Å—Ç–≤–æ (middle_name)</li>
                        <li>–î–æ–ª–∂–Ω–æ—Å—Ç—å (position)</li>
                        <li>–û—Ç–¥–µ–ª (department)</li>
                        <li>–ü–æ–¥–æ—Ç–¥–µ–ª (section)</li>
                        <li>–ö–∞–±–∏–Ω–µ—Ç (cabinet)</li>
                        <li>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (birth_date)</li>
                        <li>–û–ø–∏—Å–∞–Ω–∏–µ (description)</li>
                    </ul>
                </div>
                
                <div class="import-warning">
                    ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ï—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∂–µ email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
                </div>
            </div>
            
            <form id="uploadForm" enctype="multipart/form-data" method="post">
                <div class="file-upload-wrapper">
                    <label for="fileInput" class="file-upload-label">
                        üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª Excel
                    </label>
                    <span id="fileName" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                    <input type="file" name="file" id="fileInput" 
                           accept=".xlsx,.xls,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" 
                           required>
                </div>
                
                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span class="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</span>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeImportModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="submit-btn" id="importSubmitBtn">
                        <span class="btn-text">üöÄ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
            <h2>–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h2>
            <p class="modal-subtitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ</p>

            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="submit-btn" onclick="confirmDeleteUser()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditUserModal()">&times;</span>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
            <form id="editUserForm">
                <input type="text" id="editUserSurname" placeholder="–§–∞–º–∏–ª–∏—è" required>
                <input type="text" id="editUserName" placeholder="–ò–º—è" required>
                <input type="text" id="editUserMiddleName" placeholder="–û—Ç—á–µ—Å—Ç–≤–æ">
                <input type="email" id="editUserEmail" placeholder="Email" required>
                <input type="tel" id="editUserPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
                <input type="text" id="editUserCabinet" placeholder="–ö–∞–±–∏–Ω–µ—Ç">
                <input type="text" id="editUserPosition" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
                <input type="text" id="editUserDepartment" placeholder="–û—Ç–¥–µ–ª">
                <input type="text" id="editUserSection" placeholder="–ü–æ–¥–æ—Ç–¥–µ–ª">
                <input type="date" id="editUserBirthday" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è">
                <textarea id="editUserDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="3"></textarea>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeEditUserModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="submit-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const rowsPerPage = 10;
        let currentPage = 1;

        function createPaginationControls(totalPages) {
            const containers = [
                document.getElementById("pagination-top"),
                document.getElementById("pagination-bottom")
            ];

            containers.forEach(container => {
                container.innerHTML = "";

                const prevBtn = document.createElement("button");
                prevBtn.textContent = "‚Üê";
                prevBtn.classList.add("page-btn");
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        paginateTable();
                    }
                };
                container.appendChild(prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    btn.classList.add("page-btn");
                    if (i === currentPage) btn.classList.add("active");

                    btn.onclick = () => {
                        currentPage = i;
                        paginateTable();
                    };
                    container.appendChild(btn);
                }

                const nextBtn = document.createElement("button");
                nextBtn.textContent = "‚Üí";
                nextBtn.classList.add("page-btn");
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        paginateTable();
                    }
                };
                container.appendChild(nextBtn);
            });
        }

        function paginateTable() {
            const table = document.querySelector(".employee-table tbody");
            if (!table) return;

            const rows = Array.from(table.querySelectorAll("tr"));
            const totalPages = Math.ceil(rows.length / rowsPerPage);

            rows.forEach((row, index) => {
                row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage)
                    ? ""
                    : "none";
            });

            createPaginationControls(totalPages);
        }

        window.addEventListener("DOMContentLoaded", () => {
            paginateTable();
        });

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentEditingUser = null;
        let currentEditingInstitute = null;

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentDeletingEmail = null;
        let currentDeletingInstitute = null;
        let currentDeletingName = null;

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function openDeleteUserModal(email, institute, shortName) {
            document.getElementById('deleteConfirmModal').style.display = 'flex';
            currentDeletingEmail = email;
            currentDeletingInstitute = institute;
            currentDeletingName = shortName;

            const modalSubtitle = document.getElementById('deleteConfirmModal').querySelector('.modal-subtitle');
            if (modalSubtitle) {
                modalSubtitle.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç "${shortName}"?`;
            }
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function confirmDeleteUser() {
            if (!currentDeletingEmail || !currentDeletingInstitute) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/workers?email=${encodeURIComponent(currentDeletingEmail)}&institute=${currentDeletingInstitute}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω');
                    closeDeleteModal();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    loadAllWorkers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
            }
            
            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            currentDeletingEmail = null;
            currentDeletingInstitute = null;
            currentDeletingName = null;
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è
        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            currentDeletingEmail = null;
            currentDeletingInstitute = null;
            currentDeletingName = null;
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function openEditUserModal(email, institute) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch(`${API_BASE}/workers/${encodeURIComponent(email)}?institute=${institute}`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.user) {
                    const user = data.user;
                    currentEditingUser = user;
                    currentEditingInstitute = institute;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    document.getElementById('editUserSurname').value = user.surname || '';
                    document.getElementById('editUserName').value = user.name || '';
                    document.getElementById('editUserMiddleName').value = user.middle_name || '';
                    document.getElementById('editUserEmail').value = user.email || '';
                    document.getElementById('editUserPhone').value = user.phone_number || '';
                    document.getElementById('editUserCabinet').value = user.cabinet || '';
                    document.getElementById('editUserPosition').value = user.position || '';
                    document.getElementById('editUserDepartment').value = user.department || '';
                    document.getElementById('editUserSection').value = user.section || '';
                    document.getElementById('editUserDescription').value = user.description || '';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è input[type="date"]
                    if (user.birth_date && user.birth_date !== '0001-01-01T00:00:00Z') {
                        const birthDate = new Date(user.birth_date);
                        const formattedDate = birthDate.toISOString().split('T')[0];
                        document.getElementById('editUserBirthday').value = formattedDate;
                    } else {
                        document.getElementById('editUserBirthday').value = '';
                    }
                    
                    document.getElementById('editUserModal').style.display = 'flex';
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
            currentEditingUser = null;
            currentEditingInstitute = null;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditingUser || !currentEditingInstitute) {
                alert('–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const formData = {
                    institute: currentEditingInstitute,
                    old_email: currentEditingUser.email,
                    surname: document.getElementById('editUserSurname').value.trim(),
                    name: document.getElementById('editUserName').value.trim(),
                    middle_name: document.getElementById('editUserMiddleName').value.trim(),
                    email: document.getElementById('editUserEmail').value.trim(),
                    phone_number: document.getElementById('editUserPhone').value.trim(),
                    cabinet: document.getElementById('editUserCabinet').value.trim(),
                    position: document.getElementById('editUserPosition').value.trim(),
                    department: document.getElementById('editUserDepartment').value.trim(),
                    section: document.getElementById('editUserSection').value.trim(),
                    description: document.getElementById('editUserDescription').value.trim()
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
                const birthDate = document.getElementById('editUserBirthday').value;
                if (birthDate) {
                    formData.birth_date = new Date(birthDate).toISOString();
                }
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', formData);
                
                const response = await fetch(`${API_BASE}/workers`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                
                if (result.status === 'Ok') {
                    alert('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                    closeEditUserModal();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    loadAllWorkers();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: ' + error.message);
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        function updateActionButtons() {
            const authToken = localStorage.getItem('authToken');
            const addContactBtn = document.querySelector('.add-btn[onclick="openAddContactModal()"]');
            const importBtn = document.querySelector('.add-btn[onclick="openImportModal()"]');
            
            if (addContactBtn && importBtn) {
                if (authToken) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    addContactBtn.style.display = 'inline-block';
                    importBtn.style.display = 'inline-block';
                } else {
                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    addContactBtn.style.display = 'none';
                    importBtn.style.display = 'none';
                }
            }
        }

        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
    </script>

</body>

</html>
