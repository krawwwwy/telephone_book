<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Контакты института</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Istok+Web:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header class="header">
        <div class="header-left">
            <img src="images/logo.jpg" alt="Росатом" class="logo">
            <span class="company-name">РОСАТОМ</span>
        </div>
        <div class="header-center">
            <h1 onclick="location.href='index.html'">Телефонный справочник</h1>
        </div>
        <div class="header-right">
            <a href="admin.html" class="btn-primary">
                Админ-панель
            </a>
            <button class="btn-primary" onclick="location.href='login.html'">Войти</button>
        </div>
    </header>

    <main class="main-content">
        <aside class="sidebar">
            <div class="division-links">
                <a href="#" id="link-giredmet" onclick="switchDivision('giredmet')">Гиредмет</a> /
                <a href="#" id="link-grafit" onclick="switchDivision('grafit')">Графит</a>
            </div>
            <div id="division-button-container" style="margin-bottom: 20px; display: none;">
                <button class="btn-secondary" id="current-division-btn">Все контакты</button>
            </div>

            <ul class="department-list" id="department-list">
            </ul>
            <button class="add-btn" onclick="openAddDepartmentModal()">Добавить отдел</button>
        </aside>
        <section class="center-panel">
            <nav class="breadcrumbs" id="breadcrumbs">
            </nav>
            <button class="add-btn" onclick="openAddContactModal()">Добавить контакт</button>
            <button class="add-btn" onclick="openImportModal()">Импортировать</button>
            <h2 id="divisionTitle">Контакты</h2>
            <div class="search-wrapper">
                <input type="text" class="search-bar" id="search"
                    placeholder="Например: Иванов, Дарья, marina@gmail.com">
                <button class="search-icon-btn" onclick="handleSearchClick()"></button>
            </div>
            <div class="employee-table-wrapper">
                <div id="pagination-top" class="pagination-controls"></div>
                <table class="employee-table">
                    <thead>
                        <tr>
                            <th>ФИО</th>
                            <th>Телефон</th>
                            <th>Каб.</th>
                            <th>Email</th>
                            <th>Должность</th>
                            <th>Отдел</th>
                            <th>Подотдел</th>
                            <th>Ред.</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                    </tbody>
                </table>
                <div id="pagination-bottom" class="pagination-controls"></div>
            </div>
            <div id="results" class="search-results"></div>
        </section>




    </main>

    <footer class="footer">
        Если обнаружили неточности, напишите на почту it_rosatom@mail.ru
    </footer>

    <script>
        const API_BASE = 'http://localhost:8080';

        // Получаем параметры из URL
        const urlParams = new URLSearchParams(window.location.search);
        const division = urlParams.get('division') || 'giredmet';

        // Загрузка всех сотрудников института
        async function loadAllWorkers() {
            try {
                const response = await fetch(`${API_BASE}/workers/all?institute=${encodeURIComponent(division)}&department=`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'Ok' && data.users) {
                    const tbody = document.querySelector('#contactsTableBody');
                    tbody.innerHTML = '';
                    
                    data.users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><a href="contact.html?email=${encodeURIComponent(user.email)}" class="fio-link">${user.name}</a></td>
                            <td>${user.phone || ''}</td>
                            <td>${user.cabinet || ''}</td>
                            <td>${user.email || ''}</td>
                            <td>${user.position || ''}</td>
                            <td>${user.department || ''}</td>
                            <td>${user.section || ''}</td>
                            <td class="actions-cell">
                                <div class="actions-wrapper">
                                    <span class="icon-edit" title="Редактировать"></span>
                                    <span class="icon-delete" title="Удалить"></span>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Настраиваем обработчики для кнопок редактирования и удаления
                    setupActionButtons();
                }
            } catch (error) {
                console.error('Ошибка загрузки сотрудников:', error);
            }
        }

        // Загрузка отделов для сайдбара
        async function loadDepartments(institute) {
            try {
                const response = await fetch(`${API_BASE}/departments?institute=${encodeURIComponent(institute)}`);
                const data = await response.json();
                
                if (data.status === 'Ok' && data.departments) {
                    const list = document.getElementById('department-list');
                    list.innerHTML = '';

                    // Загружаем секции для каждого отдела
                    for (const dept of data.departments) {
                        try {
                            const sectionsResponse = await fetch(`${API_BASE}/departments/${encodeURIComponent(dept.name)}?institute=${encodeURIComponent(institute)}`);
                            const sectionsData = await sectionsResponse.json();
                            
                            if (sectionsData.status === 'Ok' && sectionsData.sections) {
                                dept.sections = sectionsData.sections;
                            } else {
                                dept.sections = [];
                            }
                        } catch (err) {
                            console.log(`Секции для отдела ${dept.name} не найдены`);
                            dept.sections = [];
                        }
                    }

                    data.departments.forEach(dept => {
                        const li = document.createElement('li');
                        li.classList.add('department-item');
                        li.innerHTML = `<span class="department-name">${dept.name}</span>`;

                        if (dept.sections && dept.sections.length > 0) {
                            const subList = document.createElement('ul');
                            subList.classList.add('subdepartment-list');
                            subList.style.display = 'none';

                            dept.sections.forEach(section => {
                                const subLi = document.createElement('li');
                                subLi.textContent = section.name;
                                subLi.onclick = () => {
                                    window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}&section=${encodeURIComponent(section.name)}`;
                                };
                                subList.appendChild(subLi);
                            });

                            li.appendChild(subList);
                            li.querySelector('.department-name').onclick = () => {
                                subList.style.display = subList.style.display === 'none' ? 'block' : 'none';
                            };
                        } else {
                            li.onclick = () => {
                                window.location.href = `departments.html?division=${encodeURIComponent(institute)}&department=${encodeURIComponent(dept.name)}`;
                            };
                        }

                        list.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки отделов:', error);
            }
        }

        function switchDivision(name) {
            // Загружаем отделы для выбранного института
            loadDepartments(name);

            const buttonContainer = document.getElementById('division-button-container');
            const divisionButton = document.getElementById('current-division-btn');

            buttonContainer.style.display = 'block';
            divisionButton.textContent = `Все контакты ${capitalize(name)}`;
            divisionButton.onclick = () => {
                window.location.href = `division.html?division=${encodeURIComponent(name)}`;
            };

            document.getElementById('link-giredmet').classList.remove('active-division');
            document.getElementById('link-grafit').classList.remove('active-division');
            document.getElementById(`link-${name}`).classList.add('active-division');
        }

        // Настройка обработчиков для кнопок действий
        function setupActionButtons() {
            document.querySelectorAll('.actions-cell').forEach(cell => {
                const tr = cell.parentElement;

                const btnEdit = cell.querySelector('.icon-edit');
                if (btnEdit) {
                    btnEdit.addEventListener('click', () => openEditFromTable(tr));
                }

                const btnDelete = cell.querySelector('.icon-delete');
                if (btnDelete) {
                    btnDelete.addEventListener('click', () => openDeleteFromTable(tr));
                }
            });
        }

        // Загрузка breadcrumbs
        function loadBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            if (!breadcrumbs) return;

            let html = `<a href="index.html">Главная</a>`;
            html += ` / ${capitalize(division)}`;
            breadcrumbs.innerHTML = html;
        }

        function capitalize(str) {
            if (!str) return '';
            const map = {
                giredmet: "Гиредмет",
                grafit: "Графит"
            };
            return map[str.toLowerCase()] || str.charAt(0).toUpperCase() + str.slice(1);
        }

        function openAddContactModal() {
            document.getElementById("addContactModal").style.display = "flex";
        }

        function closeAddContactModal() {
            document.getElementById("addContactModal").style.display = "none";
        }

        function openImportModal() {
            document.getElementById("importModal").style.display = "flex";
        }

        function closeImportModal() {
            document.getElementById("importModal").style.display = "none";
        }

        function handleSearchClick() {
            const input = document.querySelector('.search-bar');
            const value = input.value.trim();
            if (value) {
                // Поиск уже реализован через input event listener
                console.log(`Поиск: ${value}`);
            }
        }

        let contactRowToDelete = null;

        function openEditFromTable(row) {
            const fullName = row.querySelector('.fio-link').innerText;
            const position = row.cells[4].innerText;
            const department = row.cells[5].innerText;
            const email = row.cells[3].innerText;
            const workPhone = row.cells[1].innerText;
            const room = row.cells[2].innerText;

            document.getElementById('editName').value = fullName;
            document.getElementById('editPosition').value = position;
            document.getElementById('editDepartment').value = department;
            document.getElementById('editEmail').value = email;
            document.getElementById('editWorkPhone').value = workPhone;
            document.getElementById('editBirthday').value = '';
            document.getElementById('editPersonalPhone').value = '';

            document.getElementById('editModal').style.display = 'flex';
        }

        function openDeleteFromTable(row) {
            contactRowToDelete = row;
            const name = row.querySelector('.fio-link').innerText;
            const el = document.getElementById('deleteConfirmText');
            el.innerText = `Удалить контакт "${name}"?`;
            el.classList.add('modal-subtitle');
            document.getElementById('deleteContactModal').style.display = 'flex';
        }

        function closeDeleteContactModal() {
            document.getElementById('deleteContactModal').style.display = 'none';
        }

        function confirmDeleteContact() {
            if (contactRowToDelete) {
                contactRowToDelete.remove();
                contactRowToDelete = null;
            }
            closeDeleteContactModal();
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        function openAddDepartmentModal() {
            document.getElementById("addDepartmentModal").style.display = "flex";
        }

        function closeAddDepartmentModal() {
            document.getElementById("addDepartmentModal").style.display = "none";
        }

        // Обработка формы добавления контакта
        document.getElementById('contactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const inputs = e.target.querySelectorAll('input');
            
            const workerData = {
                name: inputs[0].value,
                department: inputs[1].value,
                email: inputs[2].value,
                phone: inputs[3].value,
                description: inputs[4].value,
                institute: division,
                cabinet: '',
                birthday: new Date().toISOString().split('T')[0]
            };
            
            try {
                const response = await fetch(`${API_BASE}/workers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(workerData)
                });
                
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Контакт успешно добавлен');
                    closeAddContactModal();
                    loadAllWorkers();
                    e.target.reset();
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при добавлении контакта:', error);
                alert('Ошибка при добавлении контакта');
            }
        });

        // Обработка формы добавления отдела
        document.getElementById('departmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const departmentName = formData.get('name') || e.target.querySelector('input[type="text"]').value;
            
            try {
                const response = await fetch(`${API_BASE}/departments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        name: departmentName,
                        institute: division
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Отдел успешно добавлен');
                    closeAddDepartmentModal();
                    loadDepartments(division); // Перезагружаем отделы
                    e.target.reset();
                } else {
                    alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка при добавлении отдела:', error);
                alert('Ошибка при добавлении отдела');
            }
        });

        // Обработка импорта файла
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            formData.append('institute', division);
            
            try {
                const response = await fetch(`${API_BASE}/workers/import`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });
                const result = await response.json();
                
                if (result.status === 'Ok') {
                    alert('Импорт завершён успешно');
                    loadAllWorkers();
                } else {
                    alert('Ошибка импорта: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (err) {
                alert('Ошибка при импорте файла');
                console.error(err);
            }
        });

        document.getElementById('fileInput').addEventListener('change', function () {
            const fileNameSpan = document.getElementById('fileName');
            fileNameSpan.textContent = this.files.length > 0 ? this.files[0].name : 'Файл не выбран';
        });

        window.onclick = function (event) {
            if (event.target === document.getElementById("addContactModal")) {
                closeAddContactModal();
            }

            if (event.target === document.getElementById("addDepartmentModal")) {
                closeAddDepartmentModal();
            }

            if (event.target === document.getElementById("importModal")) {
                closeImportModal();
            }
        };

        // Поиск
        document.getElementById('search').addEventListener('input', function () {
            const query = this.value;
            if (query.length < 2) {
                loadAllWorkers();
                return;
            }

            fetch(`${API_BASE}/search?institute=${encodeURIComponent(division)}&department=&query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'Ok' && data.users) {
                        const tbody = document.querySelector('#contactsTableBody');
                        tbody.innerHTML = '';
                        
                        data.users.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><a href="contact.html?email=${encodeURIComponent(user.email)}" class="fio-link">${user.name}</a></td>
                                <td>${user.phone || ''}</td>
                                <td>${user.cabinet || ''}</td>
                                <td>${user.email || ''}</td>
                                <td>${user.position || ''}</td>
                                <td>${user.department || ''}</td>
                                <td>${user.section || ''}</td>
                                <td class="actions-cell">
                                    <div class="actions-wrapper">
                                        <span class="icon-edit" title="Редактировать"></span>
                                        <span class="icon-delete" title="Удалить"></span>
                                    </div>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        setupActionButtons();
                    }
                })
                .catch(err => {
                    console.error('Ошибка поиска:', err);
                });
        });

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            const headerText = document.querySelector('#divisionTitle');
            if (headerText) {
                headerText.textContent = `Все контакты ${division === 'giredmet' ? 'Гиредмет' : 'Графит'}`;
            }
            
            loadBreadcrumbs();
            switchDivision(division);
            loadAllWorkers();
            paginateTable();
        });

    </script>

    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddContactModal()">&times;</span>
            <h2>Добавление контакта</h2>
            <p class="modal-subtitle">Заполните поля</p>
            <form id="contactForm">
                <input type="text" placeholder="ФИО контакта" required>
                <input type="text" placeholder="Отдел" required>
                <input type="email" placeholder="Почта" required>
                <input type="tel" placeholder="Рабочий телефон" required>
                <input type="text" placeholder="Описание (опционально)">
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddContactModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Добавить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeImportModal()">&times;</span>
            <h2>Импорт контактов</h2>
            <p class="modal-subtitle">Загрузите файл с контактами</p>
            <form id="uploadForm" enctype="multipart/form-data" method="post">
                <div class="file-upload-wrapper">
                    <label for="fileInput" class="file-upload-label">Выбрать файл</label>
                    <span id="fileName" class="file-name">Файл не выбран</span>
                    <input type="file" name="file" id="fileInput" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeImportModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Импортировать</button>
                </div>
            </form>
        </div>
    </div>
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
            <h2>Удаление контакта</h2>
            <p class="modal-subtitle">Подтвердите удаление</p>

            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteModal()">Отмена</button>
                <button class="submit-btn" onclick="confirmDelete()">Удалить</button>
            </div>
        </div>
    </div>

    <div id="deleteContactModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDeleteContactModal()">&times;</span>
            <h2>Удаление контакта</h2>
            <p id="deleteConfirmText">Вы уверены, что хотите удалить этот контакт?</p>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteContactModal()">Отмена</button>
                <button class="submit-btn" onclick="confirmDeleteContact()">Удалить</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeEditModal()">&times;</span>
            <h2>Редактировать контакт</h2>
            <form id="editForm">
                <input type="text" id="editName" placeholder="ФИО" required>
                <input type="text" id="editPosition" placeholder="Должность" required>
                <input type="text" id="editDepartment" placeholder="Отдел" required>
                <input type="tel" id="editWorkPhone" placeholder="Рабочий телефон" required>
                <input type="tel" id="editPersonalPhone" placeholder="Личный телефон">
                <input type="email" id="editEmail" placeholder="Email" required>
                <input type="text" id="editBirthday" placeholder="Дата рождения">
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addDepartmentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddDepartmentModal()">&times;</span>
            <h2>Добавление отдела</h2>
            <p class="modal-subtitle">Укажите название отдела<br>Отдел будет добавлен в выбранный институт</p>
            <form id="departmentForm">
                <input type="text" placeholder="Название отдела" required>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeAddDepartmentModal()">Отмена</button>
                    <button type="submit" class="submit-btn">Добавить</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const rowsPerPage = 10;
        let currentPage = 1;

        function createPaginationControls(totalPages) {
            const containers = [
                document.getElementById("pagination-top"),
                document.getElementById("pagination-bottom")
            ];

            containers.forEach(container => {
                container.innerHTML = "";

                const prevBtn = document.createElement("button");
                prevBtn.textContent = "←";
                prevBtn.classList.add("page-btn");
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        paginateTable();
                    }
                };
                container.appendChild(prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const btn = document.createElement("button");
                    btn.textContent = i;
                    btn.classList.add("page-btn");
                    if (i === currentPage) btn.classList.add("active");

                    btn.onclick = () => {
                        currentPage = i;
                        paginateTable();
                    };
                    container.appendChild(btn);
                }

                const nextBtn = document.createElement("button");
                nextBtn.textContent = "→";
                nextBtn.classList.add("page-btn");
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        paginateTable();
                    }
                };
                container.appendChild(nextBtn);
            });
        }

        function paginateTable() {
            const table = document.querySelector(".employee-table tbody");
            if (!table) return;

            const rows = Array.from(table.querySelectorAll("tr"));
            const totalPages = Math.ceil(rows.length / rowsPerPage);

            rows.forEach((row, index) => {
                row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage)
                    ? ""
                    : "none";
            });

            createPaginationControls(totalPages);
        }

        window.addEventListener("DOMContentLoaded", () => {
            paginateTable();
        });
    </script>

</body>

</html>
